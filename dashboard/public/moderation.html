<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IGNIS - Moderação</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* === Visual Overhaul Tokens & Accents === */
    :root {
      --space-1:4px; --space-2:6px; --space-3:10px; --space-4:14px; --space-5:20px;
      --radius-sm:6px; --radius-md:10px; --radius-lg:14px; --radius-xl:22px;
      --elev-1:0 2px 4px -1px rgba(0,0,0,.25),0 1px 2px rgba(0,0,0,.15);
      --elev-2:0 4px 14px -2px rgba(0,0,0,.35),0 2px 6px rgba(0,0,0,.25);
      --elev-glow:0 0 0 1px rgba(255,255,255,.05),0 0 0 4px rgba(124,58,237,.15);
      --grad-card:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.015));
      --grad-hover:linear-gradient(145deg,rgba(124,58,237,.18),rgba(124,58,237,.06));
      --focus-ring:0 0 0 2px rgba(255,255,255,.8),0 0 0 4px var(--accent, #7C3AED);
    }
    .feed-item{--accent:var(--accent-base,#7C3AED);} /* default fallback */
    .family-msg{--accent-base:#3b82f6}
    .family-mem{--accent-base:#10b981}
    .family-voice{--accent-base:#f59e0b}
    .family-ban{--accent-base:#ef4444}
    .family-chan{--accent-base:#6366f1}
    .family-role{--accent-base:#9333ea}
    /* Segmented control */
    .segmented{display:inline-flex;background:rgba(255,255,255,.05);padding:4px;border-radius:999px;position:relative;gap:4px;border:1px solid var(--glass-border)}
    .segmented .btn-toggle{position:relative;background:transparent;border:none;padding:6px 14px;font-size:.8rem;font-weight:500;color:var(--text-secondary);border-radius:999px;cursor:pointer;transition:color .25s}
    .segmented .btn-toggle.active{color:#fff}
    .segmented .seg-indicator{position:absolute;top:4px;bottom:4px;border-radius:999px;background:linear-gradient(90deg,var(--accent-base,#7C3AED),rgba(124,58,237,.6));box-shadow:0 4px 18px -4px rgba(0,0,0,.4);transition:transform .35s cubic-bezier(.4,.55,.1,1),width .35s;z-index:0}
    .segmented .btn-toggle > span{position:relative;z-index:1;display:inline-flex;align-items:center;gap:6px}
    .segmented .btn-toggle:not(.active):hover{color:var(--text-primary)}
    /* New card look */
  .feed-item{background:var(--grad-card);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06);box-shadow:var(--elev-1);position:relative;overflow:hidden}
    .feed-item:after{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:radial-gradient(circle at 30% 20%,rgba(255,255,255,.12),transparent 60%);opacity:.0;transition:opacity .5s}
    .feed-item:hover:after{opacity:.35}
    .feed-item:hover{border-color:var(--accent-base);box-shadow:0 8px 28px -6px rgba(0,0,0,.55),0 0 0 1px rgba(255,255,255,.04)}
    .feed-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .head-left{display:flex;align-items:center;gap:12px;min-width:0}
    .icon-badge{width:38px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:linear-gradient(135deg,var(--accent-base),rgba(255,255,255,.08));color:#fff;font-size:16px;box-shadow:0 4px 14px -2px var(--accent-base)}
    .feed-title-text{font-weight:600;letter-spacing:.3px;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    .feed-timestamp{font-family:ui-monospace,monospace;font-size:.68rem;color:var(--text-secondary);letter-spacing:.05em}
    .caret{transition:transform .35s ease;font-size:.7rem;opacity:.7}
    .feed-item[aria-expanded="true"] .caret{transform:rotate(90deg);opacity:1}
    .expand{transition:height .4s ease, opacity .4s ease}
    .expand[data-collapsed="true"]{height:0 !important;opacity:0;overflow:hidden}
    .expand[data-collapsed="false"]{opacity:1}
    .badge-soft{background:rgba(255,255,255,.07)}
    /* Skeletons */
    .skeleton-wave{--sk:rgba(255,255,255,.08);background:linear-gradient(100deg,rgba(255,255,255,.03),var(--sk),rgba(255,255,255,.03));background-size:200% 100%;animation:sk 1.2s linear infinite;border-radius:8px}
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .feed-skel{padding:12px 10px;border:1px solid rgba(255,255,255,.05);border-radius:14px;margin-bottom:10px;background:rgba(255,255,255,.02)}
    .feed-skel .bar{height:10px;margin-bottom:8px}
    /* Role diff chips */
    .role-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:.65rem;font-weight:600;letter-spacing:.5px}
    .role-chip.add{background:rgba(16,185,129,.18);color:#34d399;border:1px solid #10b981}
    .role-chip.rem{background:rgba(239,68,68,.18);color:#f87171;border:1px solid #ef4444}
    /* Diff text highlights */
    .diff-add{background:rgba(16,185,129,.15);color:#34d399;padding:2px 4px;border-radius:4px}
    .diff-rem{background:rgba(239,68,68,.18);color:#f87171;padding:2px 4px;border-radius:4px;text-decoration:line-through}
    /* Copy pulse */
    .btn-pulse{position:relative}
    .btn-pulse:after{content:'';position:absolute;inset:0;border-radius:inherit;box-shadow:0 0 0 0 rgba(255,255,255,.4);opacity:0}
    .btn-pulse.pulsing:after{animation:pulse 0.7s ease}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,.4);opacity:1}100%{box-shadow:0 0 0 18px rgba(255,255,255,0);opacity:0}}
    /* Smooth density/theme transitions */
    html, .feed-item, .segmented, .feed-item *{transition:background .45s, color .45s, border-color .45s, box-shadow .45s;}
    /* Focus ring */
    .btn:focus-visible, .btn-toggle:focus-visible, .qa-btn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    /* Modal improvements */
  .moderation-modal .modal-header{-webkit-backdrop-filter:blur(14px);backdrop-filter:blur(14px);background:linear-gradient(90deg,rgba(0,0,0,.55),rgba(0,0,0,.25));border-bottom:1px solid rgba(255,255,255,.07);position:sticky;top:0;z-index:5}
    .kv + .code-block, .code-block + .code-block{margin-top:10px}
    .code-block{background:linear-gradient(145deg,rgba(255,255,255,.04),rgba(0,0,0,.25));border:1px solid rgba(255,255,255,.08)!important;border-radius:10px;padding:10px;font-size:.72rem;line-height:1.25}
    .confirm-block{background:linear-gradient(160deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .confirm-block pre{max-height:320px;overflow:auto}
    .plan-diff{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .seg-spacer{flex:1 1 auto}
    /* Tooltip */
  #globalTooltip{position:fixed;z-index:9999;padding:6px 10px;background:rgba(0,0,0,.78);color:#f8f8f8;font-size:.65rem;line-height:1.2;border:1px solid rgba(255,255,255,.15);border-radius:8px;pointer-events:none;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);opacity:0;transform:translateY(2px);transition:opacity .18s,transform .18s}
  /* Export config panel styles */
  .export-config-panel{padding:14px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,.25)}
  .export-config-head{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .export-config-title{margin:0;font-size:.95rem;display:flex;align-items:center;gap:6px}
  .export-config-actions{display:flex;gap:6px;flex-wrap:wrap}
  .export-config-grid{--grid-min:240px}
  .cfg-txt{min-height:120px;font-family:monospace;font-size:.7rem}
  .export-config-errors{margin-top:12px;background:rgba(239,68,68,.15);border:1px solid #ef4444;padding:10px;border-radius:8px;font-size:.7rem;line-height:1.3}
  .export-config-errors ul{margin:6px 0 0 18px;padding:0}
  .export-config-preview{border:1px solid var(--glass-border);background:rgba(255,255,255,.04);padding:10px;border-radius:10px}
  .export-config-preview .preview-title{margin:0 0 8px;font-size:.75rem;letter-spacing:.5px;text-transform:uppercase;opacity:.8;display:flex;align-items:center;gap:6px}
  .preview-scroll{max-width:100%;overflow:auto;border:1px solid var(--glass-border);border-radius:6px}
  .preview-table{border-collapse:collapse;width:100%;font-size:.65rem}
  .preview-table th,.preview-table td{border:1px solid var(--glass-border);padding:4px 6px;text-align:left;white-space:nowrap}
  .preview-table thead{background:rgba(255,255,255,.06)}
  .field-error{outline:1px solid #ef4444}
  .export-preset-row{align-items:flex-end;gap:6px;flex-wrap:wrap}
  .export-preset-select{min-width:180px}
  .export-preview-row{align-items:flex-end;gap:6px;flex-wrap:wrap}
  .groups-enable-list{display:flex;flex-direction:column;gap:4px;max-height:140px;overflow:auto;padding:6px;border:1px solid var(--glass-border);border-radius:6px;background:rgba(255,255,255,.02)}
  .groups-enable-list label{display:flex;align-items:center;gap:6px;font-size:.7rem;background:rgba(255,255,255,.03);padding:4px 6px;border-radius:4px}
  .inline-flex-gap{display:flex;align-items:center;gap:6px}
  .groups-enable-actions{gap:6px;flex-wrap:wrap;align-items:flex-end;margin-bottom:6px}
    #globalTooltip[data-visible="true"]{opacity:1;transform:translateY(0)}
    .card-pad{padding:16px}
    .gap-12{gap:12px}
    .mt-12{margin-top:12px}
    .mt-16{margin-top:16px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .mini-stat{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(255,255,255,.03)}
    .mini-stat .icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(124,58,237,.15);color:#c4b5fd}
    .mini-stat .value{font-size:1.2rem;font-weight:700}
    .controls-row{display:flex;flex-wrap:wrap;gap:8px}
    .btn-toggle{padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,.04);color:var(--text-primary);cursor:pointer}
    .btn-toggle.active{background:rgba(124,58,237,.15);border-color:#7C3AED}
    /* Enhanced feed */
  .feed-item{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.025));border:1px solid var(--glass-border);border-radius:14px;padding:14px 12px;margin-bottom:10px;text-align:left;cursor:pointer;transition:background .18s,border-color .18s, box-shadow .18s}
  .feed-item:hover{background:linear-gradient(180deg, rgba(124,58,237,0.10), rgba(124,58,237,0.06));border-color:#7C3AED;box-shadow:0 8px 28px rgba(124,58,237,0.15)}
  .feed-meta{color:var(--text-secondary);font-size:.9rem}
    .badge-soft{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--glass-border);background:rgba(255,255,255,.04);font-size:.8rem;color:var(--text-secondary)}
    .badge-soft i{opacity:.85}
    .badge-soft[title]{cursor:pointer}
    .avatar-wrap{position:relative;width:36px;height:36px}
    .exec-avatar{position:absolute;right:-6px;bottom:-6px;width:18px;height:18px;border-radius:50%;border:2px solid var(--bg-elev);box-shadow:0 2px 6px rgba(0,0,0,.25)}
    .id-chip{display:inline-flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.05);border:1px dashed var(--glass-border);font-size:.8rem}
    .feed-row{display:flex;gap:10px;align-items:flex-start}
    .feed-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border)}
    .feed-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border)}
    .feed-content{flex:1;min-width:0}
  .feed-title{font-weight:650; letter-spacing:.2px}
  .type-pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;font-size:.78rem;border:1px solid var(--glass-border)}
    .tp-msg{background:rgba(59,130,246,.12);color:#93c5fd;border-color:#3b82f6}
    .tp-mem{background:rgba(16,185,129,.12);color:#86efac;border-color:#10b981}
    .tp-voice{background:rgba(245,158,11,.12);color:#fcd34d;border-color:#f59e0b}
    .tp-ban{background:rgba(239,68,68,.12);color:#fca5a5;border-color:#ef4444}
    .tp-role{background:rgba(147,51,234,.12);color:#d8b4fe;border-color:#9333ea}
    .tp-chan{background:rgba(99,102,241,.12);color:#c7d2fe;border-color:#6366f1}
    .expand{margin-top:8px;border-top:1px dashed var(--glass-border);padding-top:8px;display:none}
    .feed-item[aria-expanded="true"] .expand{display:block}
  .feed-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .feed-date{margin:12px 0 6px 0;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;font-size:.78rem}
    .feed-marker{margin:6px 0;padding:6px 10px;border-radius:999px;display:inline-block;background:rgba(124,58,237,.12);color:#c4b5fd;border:1px dashed #7C3AED}
    .feed-toast{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:10px;padding:6px 10px;margin-bottom:8px;box-shadow:0 8px 30px rgba(0,0,0,.12)}
  .feed-item.feed-flash{animation:flash-bg 1.1s ease 1}
    @keyframes flash-bg{0%{box-shadow:0 0 0 rgba(124,58,237,0);background:linear-gradient(180deg, rgba(124,58,237,.18), rgba(124,58,237,.10))}30%{box-shadow:0 0 0 rgba(124,58,237,.35);background:linear-gradient(180deg, rgba(124,58,237,.22), rgba(124,58,237,.12))}100%{box-shadow:0 0 0 rgba(124,58,237,0);background:transparent}}
  .align-center{align-self:center}
  /* Chips for active filters */
  .chips-row{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--glass-border);background:rgba(255,255,255,.06);color:var(--text-primary);font-size:.85rem}
  .chip .chip-clear{cursor:pointer;opacity:.8}
  .chip .chip-clear:hover{opacity:1}
  .chip-quick-clear{background:rgba(239,68,68,.15);border-color:#ef4444;color:#fca5a5;cursor:pointer;display:none}
  .chip-quick-clear i{margin-right:4px}
  .chip-quick-clear[data-visible="true"]{display:inline-flex}
  .group-mod.dragging{opacity:.6}
  .group-drag-handle{cursor:grab;padding:2px 6px;border:1px solid var(--glass-border);border-radius:6px;background:rgba(255,255,255,.05);display:inline-flex;align-items:center;gap:4px;font-size:.6rem;margin-right:4px}
  .group-drag-handle:active{cursor:grabbing}
  .hide-initial{display:none}
  .inline-group.bottom-align{align-items:flex-end;gap:4px}
  .max-w-140{max-width:140px}
  /* Copy-ID buttons are visible by default for clarity */
  /* Link actions: responsive and type-colored */
  .link-actions{display:flex;gap:6px;flex-wrap:wrap}
  .link-actions .link-btn{border:1px solid var(--glass-border);}
  .btn-link-user{background:rgba(16,185,129,.12);color:#86efac;border-color:#10b981}
  .btn-link-mod{background:rgba(147,51,234,.12);color:#d8b4fe;border-color:#9333ea}
  .btn-link-channel{background:rgba(99,102,241,.12);color:#c7d2fe;border-color:#6366f1}
  .btn-link-message{background:rgba(59,130,246,.12);color:#93c5fd;border-color:#3b82f6}
  /* Density: compact option */
  html.feed-density-compact .feed-item{padding:8px 8px;margin-bottom:8px}
  html.feed-density-compact .feed-title{font-size:.95rem}
  html.feed-density-compact .feed-meta{font-size:.82rem}
  html.feed-density-compact .badge-soft{font-size:.72rem;padding:2px 6px}
  html.feed-density-compact .type-pill{font-size:.72rem;padding:2px 8px}
  html.feed-density-compact .link-actions .link-btn{padding:4px 6px}
  /* Theme: per-type coloring for feed cards (subtle) */
  html.feed-theme-type-colored .feed-item.family-msg{background:linear-gradient(180deg, rgba(59,130,246,.08), rgba(59,130,246,.03));border-color:rgba(59,130,246,.30)}
  html.feed-theme-type-colored .feed-item.family-msg:hover{background:linear-gradient(180deg, rgba(59,130,246,.13), rgba(59,130,246,.07));border-color:#3b82f6;box-shadow:0 8px 28px rgba(59,130,246,.15)}
  html.feed-theme-type-colored .feed-item.family-mem{background:linear-gradient(180deg, rgba(16,185,129,.08), rgba(16,185,129,.03));border-color:rgba(16,185,129,.30)}
  html.feed-theme-type-colored .feed-item.family-mem:hover{background:linear-gradient(180deg, rgba(16,185,129,.13), rgba(16,185,129,.07));border-color:#10b981;box-shadow:0 8px 28px rgba(16,185,129,.15)}
  html.feed-theme-type-colored .feed-item.family-voice{background:linear-gradient(180deg, rgba(245,158,11,.10), rgba(245,158,11,.04));border-color:rgba(245,158,11,.35)}
  html.feed-theme-type-colored .feed-item.family-voice:hover{background:linear-gradient(180deg, rgba(245,158,11,.16), rgba(245,158,11,.08));border-color:#f59e0b;box-shadow:0 8px 28px rgba(245,158,11,.18)}
  html.feed-theme-type-colored .feed-item.family-ban{background:linear-gradient(180deg, rgba(239,68,68,.10), rgba(239,68,68,.04));border-color:rgba(239,68,68,.35)}
  html.feed-theme-type-colored .feed-item.family-ban:hover{background:linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.08));border-color:#ef4444;box-shadow:0 8px 28px rgba(239,68,68,.18)}
  html.feed-theme-type-colored .feed-item.family-chan{background:linear-gradient(180deg, rgba(99,102,241,.10), rgba(99,102,241,.04));border-color:rgba(99,102,241,.35)}
  html.feed-theme-type-colored .feed-item.family-chan:hover{background:linear-gradient(180deg, rgba(99,102,241,.16), rgba(99,102,241,.08));border-color:#6366f1;box-shadow:0 8px 28px rgba(99,102,241,.18)}
  html.feed-theme-type-colored .feed-item.family-role{background:linear-gradient(180deg, rgba(147,51,234,.10), rgba(147,51,234,.04));border-color:rgba(147,51,234,.35)}
  html.feed-theme-type-colored .feed-item.family-role:hover{background:linear-gradient(180deg, rgba(147,51,234,.16), rgba(147,51,234,.08));border-color:#9333ea;box-shadow:0 8px 28px rgba(147,51,234,.18)}
  /* Recency progress bar */
  .recency-bar{position:relative;height:3px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;margin-top:4px;margin-bottom:2px}
  html[data-theme="light"] .recency-bar{background:rgba(0,0,0,0.12)}
  .recency-bar span{position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,var(--accent-indigo),var(--accent-purple));transform-origin:left center;transform:scaleX(1);transition:transform .6s ease, opacity .6s ease}
  @media (max-width: 560px){
    .link-actions{gap:8px}
    .link-actions .link-btn{flex:1 1 calc(50% - 8px); text-align:center}
  }
  /* Modal: two-column layout for key-value rows on wide screens */
  .moderation-modal .modal-body #modModalBody{
    display:block;
  }
  @media (min-width: 820px){
    .moderation-modal .modal-body #modModalBody{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
    }
    .moderation-modal .modal-body #modModalBody .kv{ margin:0; }
    /* Span full width elements */
    .moderation-modal .modal-body #modModalBody .identity-row,
    .moderation-modal .modal-body #modModalBody .code-block,
    .moderation-modal .modal-body #modModalBody .actions-row{
      grid-column: 1 / -1;
    }
  }
  </style>
  </head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand"><i class="fas fa-hammer"></i> Moderação</div>
      <div class="navbar-user">
        <div class="btn-group-inline">
          <button id="themeToggle" class="btn btn-glass" title="Alternar tema"><i class="fas fa-moon"></i></button>
          <button id="contrastToggle" class="btn btn-glass" title="Alto contraste"><i class="fas fa-low-vision"></i></button>
        </div>
        <span id="healthBadge" class="badge health-badge" title="Estado do sistema">
          <span id="health-mongo" class="dot dot-gray" title="DB"></span>
          <span id="health-discord" class="dot dot-gray" title="Discord"></span>
        </span>
        <img id="userAvatar" src="/default-avatar.svg" alt="Avatar" class="user-avatar">
        <span id="userName">Carregando...</span>
        <a id="btnDashboard" href="/dashboard" class="btn btn-glass"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/logout" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </nav>
  <main class="main-content">
    <div class="container">
      <section class="dashboard-section fade-in">
        <div class="section-header">
          <h1 class="section-title"><i class="fas fa-shield-alt"></i> Moderation Center</h1>
          <p class="text-secondary">Acompanhe ações de moderação em tempo real e filtre por tipo.</p>
        </div>

        <div class="glass-card card-pad">
          <div class="controls-row">
            <div class="input-group">
              <label for="window">Janela</label>
              <select id="window" class="input" title="Intervalo de tempo para contar eventos">
                <option value="1h">Última 1h</option>
                <option value="24h" selected>Últimas 24h</option>
                <option value="7d">Últimos 7 dias</option>
              </select>
            </div>
            <div class="input-group">
              <label for="q">Pesquisar</label>
              <input id="q" class="input" placeholder="Usuário, canal, motivo..." title="Texto para pesquisar nos logs" />
            </div>
            <div class="input-group">
              <label for="from">De</label>
              <input id="from" type="date" class="input" title="Data inicial" placeholder="YYYY-MM-DD" />
            </div>
            <div class="input-group">
              <label for="to">Até</label>
              <input id="to" type="date" class="input" title="Data final" placeholder="YYYY-MM-DD" />
            </div>
            <div class="input-group">
              <label for="userId">Usuário</label>
              <input id="userId" class="input" placeholder="ID do usuário" title="Filtrar por usuário (ID)" />
            </div>
            <div class="input-group">
              <label for="moderatorId">Moderador</label>
              <input id="moderatorId" class="input" placeholder="ID do moderador" title="Filtrar por moderador (executor)" />
            </div>
            <div class="input-group">
              <label for="channelId">Canal</label>
              <input id="channelId" class="input" placeholder="ID do canal" title="Filtrar por canal" />
            </div>
          </div>
          <div class="controls-row mt-12" id="filterBar">
            <div class="segmented" id="segFilters" role="tablist" aria-label="Filtros de família">
              <div class="seg-indicator" id="segIndicator" aria-hidden="true"></div>
              <button class="btn-toggle active" data-filter="all" role="tab"><span><i class="fas fa-list"></i> Todos</span></button>
              <button class="btn-toggle" data-filter="messages" role="tab"><span><i class="fas fa-comment-dots"></i> Mensagens</span></button>
              <button class="btn-toggle" data-filter="members" role="tab"><span><i class="fas fa-user"></i> Membros</span></button>
              <button class="btn-toggle" data-filter="voice" role="tab"><span><i class="fas fa-microphone"></i> Voz</span></button>
              <button class="btn-toggle" data-filter="bans" role="tab"><span><i class="fas fa-ban"></i> Banimentos</span></button>
            </div>
            <span class="seg-spacer"></span>
            <button id="btnRefresh" class="btn btn-primary"><i class="fas fa-rotate"></i> Atualizar</button>
            <button id="btnAuto" class="btn btn-glass" aria-pressed="false"><i class="fas fa-play"></i> Auto</button>
            <button id="btnStream" class="btn btn-glass" aria-pressed="false" title="Modo stream: anexar novos eventos em tempo real"><i class="fas fa-bolt"></i> Stream</button>
            <button id="btnLatency" class="btn btn-glass" aria-pressed="false" title="Mostrar diferença de tempo entre eventos"><i class="fas fa-stopwatch"></i> Δ Tempo</button>
            <button id="btnOrder" class="btn btn-glass" aria-pressed="true" title="Ordenação: mais recente em cima (clique para alternar)"><i class="fas fa-sort-amount-down-alt"></i> Ordem</button>
            <button id="btnGroupMod" class="btn btn-glass" aria-pressed="false" title="Agrupar por moderador (colapsa eventos do mesmo executor)"><i class="fas fa-user-shield"></i> Agrupar Mods</button>
            <button id="btnClearStream" class="btn btn-glass hide-initial" title="Limpar eventos mostrados (modo stream)"><i class="fas fa-broom"></i> Limpar stream</button>
            <button id="btnGroupSortVol" class="btn btn-glass" aria-pressed="false" title="Ordenar grupos por volume (secundário: tempo)"><i class="fas fa-layer-group"></i> Volume</button>
            <button id="btnToggleShare" class="btn btn-glass" aria-pressed="true" title="Mostrar/ocultar percentagens de grupos"><i class="fas fa-percentage"></i> %</button>
            <button id="btnGroupsToggle" class="btn btn-glass" data-state="expanded" title="Colapsar todos os grupos"><i class="fas fa-compress-alt"></i> Colapsar</button>
            <div class="input-group hide-initial" id="groupSearchWrap" title="Pesquisar moderador dentro dos grupos">
              <label for="groupModSearch">Procurar mod</label>
              <input id="groupModSearch" class="input" placeholder="Nome ou ID" />
            </div>
            <div class="input-group">
              <label for="densitySelect">Densidade</label>
              <select id="densitySelect" class="input" title="Densidade do feed">
                <option value="comfortable">Confortável</option>
                <option value="compact">Compacto</option>
              </select>
            </div>
            <div class="input-group">
              <label for="themeSelect">Tema</label>
              <select id="themeSelect" class="input" title="Tema de cor do feed">
                <option value="subtle">Subtil</option>
                <option value="type-colored">Por tipo</option>
              </select>
            </div>
            <div class="input-group">
              <label for="longPauseMin">Pausa longa</label>
              <div class="inline-group">
                <input id="longPauseMin" type="number" class="input w-120" value="2" min="1" max="60" title="Minutos até marcar retoma"/>
                <span class="text-secondary align-center">min</span>
              </div>
            </div>
            <div class="input-group">
              <label for="exportFormat">Exportar</label>
              <div class="inline-group">
                <select id="exportFormat" class="input" title="Formato de exportação">
                  <option value="csv" selected>CSV</option>
                  <option value="json">JSON</option>
                </select>
                <button id="btnExport" class="btn btn-glass" title="Exportar eventos no formato selecionado"><i class="fas fa-download"></i> Exportar</button>
                <button id="btnExportSnapshot" class="btn btn-glass" title="Exportar feed como HTML estático"><i class="fas fa-camera"></i> Snapshot</button>
                <button id="btnLoadAll" class="btn btn-glass" title="Carregar todos os eventos ignorando virtualização"><i class="fas fa-layer-group"></i> Carregar tudo</button>
                <button id="btnExportGroups" class="btn btn-glass hide-initial" title="Exportar estatísticas dos grupos (quando agrupado)"><i class="fas fa-table"></i> Export Grupos</button>
                <button id="btnExportConfig" class="btn btn-glass" title="Configuração avançada de exportação"><i class="fas fa-sliders-h"></i></button>
                <div class="inline-group bottom-align">
                  <label for="presetSelect" class="sr-only">Presets</label>
                  <select id="presetSelect" class="input max-w-140" title="Presets de filtros">
                    <option value="">Presets...</option>
                  </select>
                  <button id="btnSavePreset" class="btn btn-glass" title="Guardar preset atual"><i class="fas fa-save"></i></button>
                  <button id="btnDeletePreset" class="btn btn-glass" title="Apagar preset selecionado"><i class="fas fa-trash"></i></button>
                </div>
              </div>
            </div>
          </div>
          <!-- Painel de configuração de exportação -->
          <div id="exportConfigPanel" class="glass-card mt-12 export-config-panel" hidden>
            <div class="export-config-head">
              <h4 class="export-config-title"><i class="fas fa-sliders-h"></i> Configuração de Exportação</h4>
              <div class="export-config-actions">
                <button id="btnExportConfigClose" class="btn btn-glass" title="Fechar painel"><i class="fas fa-times"></i></button>
                <button id="btnExportConfigReset" class="btn btn-glass" title="Repor padrão"><i class="fas fa-undo"></i> Reset</button>
                <button id="btnExportConfigPreview" class="btn btn-glass" title="Pré-visualizar cabeçalhos"><i class="fas fa-eye"></i> Preview</button>
                <button id="btnExportConfigSave" class="btn btn-primary" title="Guardar alterações"><i class="fas fa-check"></i> Guardar</button>
              </div>
            </div>
            <div class="grid-auto mt-12 export-config-grid">
              <div>
                <label class="lbl">Chaves whitelist (uma por linha)</label>
                <textarea id="cfgWhitelist" class="input cfg-txt" placeholder="id\ntimestamp\nresolved.executor.id"></textarea>
                <small class="text-secondary">Se preenchido, apenas estas chaves serão exportadas.</small>
              </div>
              <div>
                <label class="lbl">Prefixes (uma por linha)</label>
                <textarea id="cfgPrefixes" class="input cfg-txt" placeholder="resolved.executor.\nresolved.target."></textarea>
                <small class="text-secondary">Usado somente se whitelist vazio.</small>
              </div>
              <div>
                <label class="lbl">Mapeamento de cabeçalhos (raw=Bonito)</label>
                <textarea id="cfgHeaderMap" class="input cfg-txt" placeholder="id=Log ID\nresolved.executor.id=Executor ID"></textarea>
                <small class="text-secondary">Um por linha.</small>
              </div>
              <div>
                <label class="lbl">Modo ordenação</label>
                <select id="cfgOrderMode" class="input">
                  <option value="whitelist">Whitelist</option>
                  <option value="alphabetical">Alfabética</option>
                  <option value="grouped">Agrupada</option>
                </select>
                <label class="lbl mt-8"><input type="checkbox" id="cfgGroupedSections"/> Inserir linhas de separação</label>
              </div>
              <div>
                <label class="lbl">Formato Data/Hora</label>
                <select id="cfgDateFormat" class="input">
                  <option value="iso">ISO</option>
                  <option value="locale">Locale</option>
                  <option value="epoch">Epoch (ms)</option>
                </select>
                <label class="lbl mt-8"><input type="checkbox" id="cfgIncludeArrays" checked/> Incluir arrays</label>
                <label class="lbl mt-4">Profundidade máxima<br><input type="number" id="cfgMaxDepth" class="input w-120" min="1" value="10"/></label>
              </div>
              <div>
                <label class="lbl">Grupos (regex=label)</label>
                <textarea id="cfgGroups" class="input cfg-txt" placeholder="^(id|timestamp|type)$=Identificação\n^resolved\.executor\.=Executor\n^resolved\.target\.=Alvo\n^(action|reason)$=Ação"></textarea>
                <small class="text-secondary">Usado quando modo=agrupada.</small>
              </div>
              <div>
                <label class="lbl">Pré-visualização</label>
                <div class="inline-group export-preview-row">
                  <select id="cfgPreviewLimit" class="input w-120" title="Linhas de pré-visualização">
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                  </select>
                  <label class="lbl inline-flex-gap"><input type="checkbox" id="cfgIncludeRaw"/> Incluir objeto original (JSON export)</label>
                </div>
                <small class="text-secondary">Objetos originais apenas no JSON.</small>
              </div>
              <div>
                <label class="lbl">Ativar/Desativar Grupos</label>
                <div class="inline-group groups-enable-actions">
                  <input id="cfgGroupsSearch" class="input w-120" placeholder="Procurar..." title="Filtrar grupos" />
                  <button id="btnGroupsEnableAll" class="btn btn-glass" title="Ativar todos"><i class="fas fa-check-double"></i></button>
                  <button id="btnGroupsDisableAll" class="btn btn-glass" title="Desativar todos"><i class="fas fa-ban"></i></button>
                </div>
                <div id="cfgGroupsEnable" class="groups-enable-list"></div>
                <small class="text-secondary">Desmarcar para excluir colunas desse grupo.</small>
              </div>
              <div>
                <label class="lbl">Presets de Exportação</label>
                <div class="inline-group export-preset-row">
                  <select id="cfgPresetSelect" class="input export-preset-select">
                    <option value="">Selecionar preset...</option>
                  </select>
                  <button id="btnCfgApplyPreset" class="btn btn-glass" title="Aplicar preset"><i class="fas fa-play"></i> Aplicar</button>
                  <button id="btnCfgSavePreset" class="btn btn-glass" title="Guardar como preset"><i class="fas fa-save"></i> Guardar</button>
                  <button id="btnCfgDeletePreset" class="btn btn-glass" title="Apagar preset"><i class="fas fa-trash"></i></button>
                  <button id="btnCfgExportPresets" class="btn btn-glass" title="Exportar presets (ficheiro)"><i class="fas fa-file-export"></i></button>
                  <button id="btnCfgImportPresets" class="btn btn-glass" title="Importar presets (ficheiro)"><i class="fas fa-file-import"></i></button>
                  <button id="btnCfgSyncPull" class="btn btn-glass" title="Obter presets do servidor"><i class="fas fa-cloud-download-alt"></i></button>
                  <button id="btnCfgSyncPush" class="btn btn-glass" title="Enviar presets para o servidor"><i class="fas fa-cloud-upload-alt"></i></button>
                  <button id="btnCfgSyncDelete" class="btn btn-glass" title="Apagar preset remoto selecionado"><i class="fas fa-cloud-minus"></i></button>
                  <input id="cfgImportFile" type="file" accept="application/json" hidden />
                </div>
                <small class="text-secondary">Presets armazenados localmente.</small>
              </div>
              <div>
                <label class="lbl">Opções CSV</label>
                <label class="lbl inline-flex-gap"><input type="checkbox" id="cfgIncludeRawCSV"/> Incluir objeto original (coluna)</label>
                <label class="lbl mt-4">Nome da coluna RAW<br><input id="cfgRawCSVName" class="input w-120" value="__raw"/></label>
                <small class="text-secondary">JSON do log original escapeado.</small>
              </div>
            </div>
            <div id="exportConfigErrors" class="export-config-errors" aria-live="polite" hidden></div>
            <div id="exportConfigPreview" class="export-config-preview mt-12" hidden>
              <h5 class="preview-title"><i class="fas fa-table"></i> Pré-visualização</h5>
              <div class="preview-scroll">
                <table class="preview-table" aria-label="Pré-visualização de exportação"><thead></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
          <div id="activeFilters" class="chips-row mt-12" aria-live="polite">
            <span id="quickClearPills" class="chip chip-quick-clear" data-visible="false" data-tip="Limpar apenas filtros rápidos (pills)"><i class="fas fa-eraser"></i> Limpar filtros rápidos</span>
          </div>
          <div id="recencyLegend" class="text-secondary mt-8 recency-legend"></div>
          <div id="globalProgress" class="progress-global mt-8" aria-hidden="true" aria-label="Progresso de carregamento" role="progressbar" aria-valuemin="0" aria-valuemax="100"><span></span></div>
          <div class="pagination-row mt-12" id="pagination" aria-label="Paginação">
            <button id="pagePrev" class="btn btn-glass" title="Página anterior" disabled><i class="fas fa-chevron-left"></i></button>
            <button id="pageNext" class="btn btn-glass" title="Próxima página" disabled><i class="fas fa-chevron-right"></i></button>
            <label class="inline-group pagination-label">Pág:
              <input id="pageInput" type="number" class="input w-120" min="1" value="1" title="Ir para página" />
                <option value="200">200</option>
                <option value="400">400</option>
              </select>
            </label>
            <span id="pageInfo" class="text-secondary page-info"></span>
          </div>
        </div>

        <div class="grid-auto mt-16" id="statsGrid">
          <div class="mini-stat"><div class="icon"><i class="fas fa-ban"></i></div><div><div class="label">Banimentos</div><div class="value" id="countBans">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-comment-slash"></i></div><div><div class="label">Mensagens apagadas</div><div class="value" id="countMsgDel">-</div></div></div>
            <div class="mt-12 inline-flex-gap export-preset-row">
              <select id="cfgPresetSelectQuick" class="input export-preset-select" title="Preset de exportação (rápido)"></select>
              <button id="cfgPresetApplyQuick" class="btn btn-glass" title="Aplicar preset selecionado"><i class="fas fa-play"></i></button>
              <button id="cfgPresetSaveQuick" class="btn btn-glass" title="Guardar configuração atual como preset"><i class="fas fa-save"></i></button>
              <button id="cfgPresetDeleteQuick" class="btn btn-glass" title="Apagar preset selecionado"><i class="fas fa-trash"></i></button>
              <button id="cfgPresetExportFileQuick" class="btn btn-glass" title="Exportar presets"><i class="fas fa-file-export"></i></button>
              <label class="btn btn-glass" title="Importar presets"><i class="fas fa-file-import"></i><input id="cfgPresetImportFileQuick" type="file" accept="application/json" hidden/></label>
              <button id="cfgPresetSyncPullQuick" class="btn btn-glass" title="Obter presets do servidor"><i class="fas fa-cloud-download-alt"></i></button>
              <button id="cfgPresetSyncPushQuick" class="btn btn-glass" title="Enviar presets para o servidor"><i class="fas fa-cloud-upload-alt"></i></button>
              <button id="cfgPresetSyncDeleteQuick" class="btn btn-glass" title="Apagar preset remoto selecionado"><i class="fas fa-cloud-minus"></i></button>
            </div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-pen"></i></div><div><div class="label">Mensagens editadas</div><div class="value" id="countMsgEdit">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-users"></i></div><div><div class="label">Entradas/Saídas</div><div class="value" id="countJoinsLeaves">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-microphone"></i></div><div><div class="label">Eventos de voz</div><div class="value" id="countVoice">-</div></div></div>
        </div>

        <div class="glass-card card-pad mt-16">
          <h3 class="section-title"><i class="fas fa-chart-line"></i> Últimos 7 dias</h3>
          <canvas id="mod7Chart" height="120" aria-label="Tendência 7 dias" role="img"></canvas>
        </div>

        <div class="glass-card card-pad mt-16">
          <h3 class="section-title"><i class="fas fa-stream"></i> Feed</h3>
          <div id="feed" class="mt-12" aria-live="polite"></div>
        </div>

        <div class="glass-card card-pad mt-16" id="hierTools">
          <h3 class="section-title"><i class="fas fa-sitemap"></i> Hierarquia rápida</h3>
          <p class="text-secondary">Mover rapidamente cargos e canais. Use com cuidado.</p>
          <div id="roleManagerPanel" class="mt-12">
            <h4 class="section-subtitle"><i class="fas fa-user-shield"></i> Gestão de Cargos</h4>
            <div class="controls-row mt-8">
              <input id="rmNewRoleName" class="input" placeholder="Novo cargo" maxlength="80" />
              <input id="rmNewRoleColor" class="input w-120" placeholder="#hex" maxlength="7" />
              <button id="rmBtnCreateRole" class="btn btn-glass" title="Criar cargo"><i class="fas fa-plus"></i></button>
              <input id="rmSearchRole" class="input max-w-140" placeholder="Pesquisar..." />
              <button id="rmBtnRefreshRoles" class="btn btn-glass" title="Atualizar lista"><i class="fas fa-rotate"></i></button>
            </div>
            <div id="rmRolesList" class="roles-list mt-8" aria-label="Lista de cargos"></div>
            <template id="tplRoleItem">
              <div class="role-item" data-role-id="" style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);padding:6px 8px;border:1px solid var(--glass-border);border-radius:8px">
                <span class="ri-color" style="width:14px;height:14px;border-radius:4px;background:#666"></span>
                <span class="ri-name" style="flex:1;min-width:0;font-size:.8rem;font-weight:500;letter-spacing:.3px"></span>
                <span class="ri-pos badge-soft" style="font-size:.6rem"></span>
                <button class="btn btn-xs btn-glass ri-up" title="Subir"><i class="fas fa-arrow-up"></i></button>
                <button class="btn btn-xs btn-glass ri-down" title="Descer"><i class="fas fa-arrow-down"></i></button>
                <button class="btn btn-xs btn-danger ri-del" title="Apagar"><i class="fas fa-trash"></i></button>
              </div>
            </template>
          </div>
          <div class="grid-auto mt-12">
            <div>
              <h4 class="section-subtitle"><i class="fas fa-user-tag"></i> Cargos</h4>
              <div class="controls-row mt-8">
                <input id="roleIdQuick" class="input" placeholder="ID do cargo" title="Role ID" />
                <input id="roleSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnRoleUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnRoleDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
            </div>
            <div>
              <h4 class="section-subtitle"><i class="fas fa-hashtag"></i> Canais</h4>
              <div class="controls-row mt-8">
                <input id="channelIdQuick" class="input" placeholder="ID do canal" title="Channel ID" />
                <input id="channelSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnChanUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnChanDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
              <div class="controls-row mt-8">
                <input id="channelToCategory" class="input" placeholder="ID categoria alvo (opcional)" title="Categoria" />
                <button id="btnMoveToCategory" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Mover para categoria</button>
              </div>
            </div>
          </div>
          <div class="mt-12"><label><input type="checkbox" id="hierDryRun" checked/> Pré-visualizar antes de aplicar</label></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal para detalhes de evento de moderação -->
  <div id="moderationModal" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content ticket-modal moderation-modal">
      <div class="modal-header">
        <h2 id="modModalTitle">Detalhes do evento</h2>
  <button class="modal-close" aria-label="Fechar" onclick="(function(m){m.classList.add('modal-hidden');m.classList.remove('modal-visible');m.setAttribute('aria-hidden','true');})(document.getElementById('moderationModal'))">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modModalBody">Carregando...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4" crossorigin="anonymous"></script>
  <script>
    // Connect to socket server for live updates
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        const guildId = params.get('guildId');
        if (!guildId) return;
        const socket = io('/', { transports: ['websocket','polling'] });
        socket.on('connect', () => {
          try { socket.emit('joinGuild', guildId); } catch {}
        });
        socket.on('moderation_event', async (payload) => {
          // Debounced refresh to avoid spamming on bursts
          if (!window.__modRefreshPending) {
            window.__modRefreshPending = true;
            setTimeout(async () => {
              try {
                if (window.ModerationPage && typeof window.ModerationPage.handleLiveEvent === 'function') {
                  const handled = await window.ModerationPage.handleLiveEvent(payload);
                  if (!handled && typeof window.ModerationPage.refresh === 'function') {
                    await window.ModerationPage.refresh();
                  }
                } else {
                  // Fallback: soft reload of key widgets
                  const ev = new CustomEvent('moderation:refresh');
                  window.dispatchEvent(ev);
                }
              } finally { window.__modRefreshPending = false; }
            }, 800);
          }
        });
      } catch {}
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/js/moderation.js"></script>
  <!-- Modal Diff Presets -->
  <div id="presetDiffModal" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content preset-diff-modal-size">
      <div class="modal-header">
        <h2 id="presetDiffTitle">Diferenças de Presets</h2>
        <button class="modal-close" aria-label="Fechar" id="presetDiffClose">&times;</button>
      </div>
      <div class="modal-body" id="presetDiffBody">
        <p class="text-secondary" id="presetDiffIntro">Pré-visualização das alterações antes de aplicar.</p>
  <div id="presetDiffSummary" class="preset-diff-summary"></div>
  <div id="presetDiffDetails" class="preset-diff-details"></div>
  <div class="mt-12 preset-diff-actions">
          <button id="presetDiffMerge" class="btn btn-primary"><i class="fas fa-check"></i> Aplicar / Merge</button>
          <button id="presetDiffReplace" class="btn btn-glass"><i class="fas fa-exchange-alt"></i> Substituir Tudo</button>
          <button id="presetDiffCancel" class="btn btn-danger"><i class="fas fa-times"></i> Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Shortcut Help Overlay -->
  <div id="shortcutOverlay" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content modal-wide">
      <div class="modal-header">
        <h2>Atalhos</h2>
        <button class="modal-close" aria-label="Fechar" onclick="(function(m){m.classList.add('modal-hidden');m.classList.remove('modal-visible');m.setAttribute('aria-hidden','true');})(document.getElementById('shortcutOverlay'))">&times;</button>
      </div>
      <div class="modal-body">
        <ul class="shortcut-list">
          <li><kbd>?</kbd> / <kbd>Shift</kbd> + <kbd>/</kbd> — Mostrar/Ocultar esta ajuda</li>
          <li><kbd>F</kbd> — Focar campo de pesquisa</li>
          <li><kbd>R</kbd> — Atualizar (resumo + feed)</li>
          <li><kbd>A</kbd> — Alternar Auto refresh</li>
          <li><kbd>T</kbd> — Alternar tema claro/escuro</li>
          <li><kbd>C</kbd> — Alternar alto contraste</li>
          <li><kbd>1</kbd> / <kbd>2</kbd> / <kbd>3</kbd> / <kbd>4</kbd> / <kbd>5</kbd> — Alternar filtros (Todos, Mensagens, Membros, Voz, Banimentos)</li>
          <li><kbd>Esc</kbd> — Fechar modais</li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    // Theme toggle (light/dark) persisted in localStorage
    (function(){
      try {
        const key='ui-theme';
        const apply=(t)=>{ document.documentElement.setAttribute('data-theme', t); };
        const saved = localStorage.getItem(key) || 'dark';
        apply(saved);
        const btn = document.getElementById('themeToggle');
        const setIcon = ()=>{ btn.innerHTML = (document.documentElement.getAttribute('data-theme')==='light')? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; };
        setIcon();
        btn?.addEventListener('click', ()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; const next = (cur==='dark')?'light':'dark'; apply(next); localStorage.setItem(key,next); setIcon(); });
      } catch {}
    })();
    // Density/Theme selectors persisted and applied as html classes
    (function(){
      try {
        const densKey = 'mod-feed-density';
        const themeKey = 'mod-feed-theme';
        const html = document.documentElement;
        const applyDensity = (v)=>{
          html.classList.toggle('feed-density-compact', v==='compact');
        };
        const applyTheme = (v)=>{
          html.classList.toggle('feed-theme-type-colored', v==='type-colored');
        };
        const dSel = document.getElementById('densitySelect');
        const tSel = document.getElementById('themeSelect');
  let savedD = localStorage.getItem(densKey);
  let savedT = localStorage.getItem(themeKey);
  const validDensity = new Set(['comfortable','compact']);
  const validTheme = new Set(['subtle','type-colored']);
  if (!validDensity.has(savedD)) savedD = 'compact';
  if (!validTheme.has(savedT)) savedT = 'type-colored';
  applyDensity(savedD);
  applyTheme(savedT);
  if (dSel) dSel.value = savedD;
  if (tSel) tSel.value = savedT;
        dSel?.addEventListener('change', ()=>{ const v=dSel.value; localStorage.setItem(densKey, v); applyDensity(v); });
        tSel?.addEventListener('change', ()=>{ const v=tSel.value; localStorage.setItem(themeKey, v); applyTheme(v); });
      } catch {}
    })();
    // Navbar user avatar/name & health
    // Navbar user avatar/name & health
    (async()=>{ try{ const r = await fetch('/api/user'); const d = await r.json(); if(d?.success){ const a=document.getElementById('userAvatar'); const n=document.getElementById('userName'); if(a&&d.user.avatar) a.src=d.user.avatar; if(n) n.textContent=d.user.username; } }catch{} })();
    (async()=>{ const setTip=(t)=>{const hb=document.getElementById('healthBadge'); if(hb) hb.title=t;}; const dot=(el, st)=>{ if(!el) return; el.classList.remove('dot-green','dot-red','dot-gray'); el.classList.add(st==='ok'?'dot-green': st==='bad'?'dot-red':'dot-gray');}; try{ const r=await fetch('/api/health',{credentials:'same-origin'}); const h=await r.json(); dot(document.getElementById('health-mongo'), h.mongo==='connected'?'ok': (h.mongo==='disabled'?'gray':'bad')); dot(document.getElementById('health-discord'), h.discord?'ok':'bad'); setTip(`${h.mongo==='connected'?'DB: ligado': h.mongo==='disabled'?'DB: desativado':'DB: desligado'} • ${h.discord?'Discord: online':'Discord: offline'}`);}catch{}})();
    // Segmented control indicator logic
    (function(){
      const seg = document.getElementById('segFilters');
      const ind = document.getElementById('segIndicator');
      if(!seg || !ind) return;
      function sync(){
        const active = seg.querySelector('.btn-toggle.active');
        if(!active) return;
        const r = active.getBoundingClientRect();
        const rs = seg.getBoundingClientRect();
        const w = r.width;
        const x = r.left - rs.left;
        ind.style.width = w + 'px';
        ind.style.transform = `translateX(${x}px)`;
      }
      const ro = new ResizeObserver(()=>sync()); ro.observe(seg);
      new MutationObserver(()=>sync()).observe(seg,{attributes:true,subtree:true,attributeFilter:['class']});
      window.addEventListener('load', ()=> setTimeout(sync,60));
      window.addEventListener('resize', ()=> sync());
    })();
    // Enhance copy buttons with pulse feedback (delegated)
    (function(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.copy-summary, #btnCopyDetails');
        if(!btn) return;
        btn.classList.add('btn-pulse','pulsing');
        setTimeout(()=> btn.classList.remove('pulsing'), 700);
      });
    })();
    // Skeleton loader helper (if feed empty & loading class used by JS earlier)
    (function(){
      const feed = document.getElementById('feed');
      if(!feed) return;
      if(feed.children.length===0){
        const frag = document.createDocumentFragment();
        for(let i=0;i<4;i++){
          const sk = document.createElement('div'); sk.className='feed-skel';
          for(let b=0;b<3;b++){ const bar=document.createElement('div'); bar.className='bar skeleton-wave'; bar.style.width=(60+Math.random()*30)+'%'; sk.appendChild(bar);} frag.appendChild(sk);
        }
        feed.appendChild(frag);
      }
    })();
    // High contrast toggle persistence
    (function(){
      try {
        const key='ui-contrast';
        const html=document.documentElement;
        const btn=document.getElementById('contrastToggle');
        const apply=(v)=>{ html.classList.toggle('high-contrast', v==='on'); };
        const saved = localStorage.getItem(key)||'off';
        apply(saved);
        const setIcon=()=>{ btn.innerHTML = html.classList.contains('high-contrast')? '<i class="fas fa-eye"></i>' : '<i class="fas fa-low-vision"></i>'; };
        setIcon();
        btn?.addEventListener('click', ()=>{ const next = html.classList.contains('high-contrast')? 'off':'on'; apply(next); localStorage.setItem(key,next); setIcon(); });
      } catch {}
    })();
    // Global custom tooltip system (replaces native title tooltips for richer styling)
    (function(){
      const TIP_ATTR = 'data-tip';
      let tipEl = document.getElementById('globalTooltip');
      if(!tipEl){
        tipEl = document.createElement('div');
        tipEl.id = 'globalTooltip';
        document.body.appendChild(tipEl);
      }
      let currentTarget = null;
      let hideTimeout = null;
      const gap = 10;
      function showTip(target){
        if(!target) return;
        const raw = target.getAttribute(TIP_ATTR) || target.getAttribute('title');
        if(!raw) return;
        // If still has title attr, move it to data-tip to prevent native tooltip
        if(target.hasAttribute('title')){ target.setAttribute(TIP_ATTR, raw); target.removeAttribute('title'); }
        tipEl.textContent = raw;
        tipEl.setAttribute('data-visible','true');
        position(target);
      }
      function hideTip(){
        tipEl.removeAttribute('data-visible');
        currentTarget = null;
      }
      function position(target, evt){
        if(!target || !document.documentElement.contains(target)) { hideTip(); return; }
        let rect;
        try { rect = target.getBoundingClientRect(); } catch { hideTip(); return; }
        const ttRect = tipEl.getBoundingClientRect();
        const vw = window.innerWidth; const vh = window.innerHeight;
        let x = rect.left + (rect.width/2) - (ttRect.width/2);
        let y = rect.top - ttRect.height - gap;
        if(y < 4){ y = rect.bottom + gap; }
        if(x < 4) x = 4; if(x + ttRect.width > vw - 4) x = vw - ttRect.width - 4;
        if(y + ttRect.height > vh - 4) y = vh - ttRect.height - 4;
        tipEl.style.left = x + 'px';
        tipEl.style.top = y + 'px';
        if(evt){
          // If triggered by mousemove and near edges adjust quickly
        }
      }
      document.addEventListener('mouseover', (e)=>{
        const t = e.target.closest('[data-tip], [title]');
        if(!t){
            if(currentTarget){ hideTip(); }
            return;
        }
        if(t===currentTarget) return;
        currentTarget = t;
        clearTimeout(hideTimeout);
        showTip(t);
      });
      document.addEventListener('mousemove', (e)=>{
        if(!currentTarget) return;
        // Slight throttling via requestAnimationFrame
        if(!window.__tipRaf){
          window.__tipRaf = requestAnimationFrame(()=>{
            window.__tipRaf = null;
            if(!currentTarget || !document.documentElement.contains(currentTarget)) { hideTip(); return; }
            position(currentTarget, e);
          });
        }
      });
      document.addEventListener('mouseout', (e)=>{
        if(!currentTarget) return;
        if(!e.relatedTarget || !e.relatedTarget.closest('[data-tip], [title]')){
          hideTimeout = setTimeout(hideTip, 120);
        }
      });
      window.addEventListener('scroll', ()=>{ if(currentTarget) position(currentTarget); }, true);
      window.addEventListener('resize', ()=>{ if(currentTarget) position(currentTarget); });
    })();
    // Keyboard shortcuts overlay & handlers
    (function(){
      const overlay = document.getElementById('shortcutOverlay');
      const toggleOverlay = ()=>{
        if(!overlay) return;
        const vis = overlay.classList.contains('modal-visible');
        if(vis){ overlay.classList.add('modal-hidden'); overlay.classList.remove('modal-visible'); overlay.setAttribute('aria-hidden','true'); }
        else { overlay.classList.remove('modal-hidden'); overlay.classList.add('modal-visible'); overlay.setAttribute('aria-hidden','false'); }
      };
      document.addEventListener('keydown', (e)=>{
        if(e.key === '/' && e.shiftKey){ e.preventDefault(); toggleOverlay(); return; }
        if(e.key === '?' ){ e.preventDefault(); toggleOverlay(); return; }
        if(e.key === 'Escape'){
          if(overlay?.classList.contains('modal-visible')){ toggleOverlay(); return; }
          const mod = document.getElementById('moderationModal');
          if(mod?.classList.contains('modal-visible')){ mod.classList.add('modal-hidden'); mod.classList.remove('modal-visible'); mod.setAttribute('aria-hidden','true'); }
        }
        if(e.target && (['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName))) return;
        switch(e.key){
          case 'F': case 'f': { const q=document.getElementById('q'); if(q){ q.focus(); q.select(); } break; }
          case 'R': case 'r': { const btn=document.getElementById('btnRefresh'); btn?.click(); break; }
          case 'A': case 'a': { const btn=document.getElementById('btnAuto'); btn?.click(); break; }
          case 'T': case 't': { const btn=document.getElementById('themeToggle'); btn?.click(); break; }
          case 'C': case 'c': { const btn=document.getElementById('contrastToggle'); btn?.click(); break; }
          case '1': { document.querySelector('[data-filter="all"]')?.click(); break; }
          case '2': { document.querySelector('[data-filter="messages"]')?.click(); break; }
          case '3': { document.querySelector('[data-filter="members"]')?.click(); break; }
          case '4': { document.querySelector('[data-filter="voice"]')?.click(); break; }
          case '5': { document.querySelector('[data-filter="bans"]')?.click(); break; }
        }
      });
    })();
  </script>
    <style>
    /* Light theme overrides for this page using CSS variables */
    html[data-theme="light"] {
      --bg-primary: #F7F7FB;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F1F5F9;
      --bg-card: rgba(0,0,0,0.03);
      --bg-glass: rgba(99,102,241,0.08);
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-muted: #6B7280;
      --glass-border: rgba(0,0,0,0.12);
    }
    /* High contrast accessibility mode */
    html.high-contrast {
      --bg-primary: #000000 !important;
      --bg-secondary: #0B0B0B !important;
      --bg-tertiary: #141414 !important;
      --bg-card: #101010 !important;
      --bg-glass: rgba(255,255,255,0.08) !important;
      --text-primary: #FFFFFF !important;
      --text-secondary: #E5E7EB !important;
      --text-muted: #D1D5DB !important;
      --border-color: #FFFFFF !important;
      --accent-blue: #60A5FA !important;
      --accent-green: #34D399 !important;
      --accent-red: #F87171 !important;
      --accent-yellow: #FBBF24 !important;
      --accent-purple: #C084FC !important;
      --accent-pink: #F472B6 !important;
      --accent-indigo: #818CF8 !important;
      --shadow-elev-1: 0 0 0 1px #ffffff, 0 0 0 2px #000000;
      --shadow-elev-2: 0 0 0 1px #ffffff, 0 2px 4px rgba(0,0,0,.6);
    }
    html.high-contrast .feed-item { border:1px solid #FFFFFF; }
    html.high-contrast .feed-card { border:1px solid #FFFFFF; }
    html.high-contrast .btn { box-shadow:0 0 0 2px #fff inset; }
    html.high-contrast .btn.btn-secondary { background:#2563EB; color:#fff; }
    html.high-contrast .segmented { border:1px solid #fff; }
    html.high-contrast #segIndicator { background:#fff; mix-blend-mode:normal; }
    html.high-contrast .chip { border-color:#fff; }
    html.high-contrast #globalTooltip { background:#111; border:1px solid #fff; color:#fff; }
    .shortcut-list{list-style:none;padding:0;margin:0;display:grid;gap:6px;font-size:.8rem}
    .shortcut-list li{background:var(--bg-tertiary);padding:6px 10px;border-radius:6px;line-height:1.3}
    kbd{display:inline-block;padding:2px 6px;border:1px solid var(--glass-border);border-radius:4px;font-size:.65rem;background:var(--bg-elev);font-weight:600;margin:0 2px}
    .recency-legend{font-size:.65rem;opacity:.8}
    .modal-wide{max-width:640px}
    .progress-global{position:relative;height:6px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;opacity:0;transition:opacity .25s}
    html[data-theme="light"] .progress-global{background:rgba(0,0,0,0.12)}
    .progress-global[data-active="true"]{opacity:1}
    .progress-global span{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--accent-indigo),var(--accent-purple));transition:width .25s}
    .pagination-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pagination-label{display:flex;align-items:center;gap:4px;font-size:.7rem}
    .page-info{font-size:.65rem}
    .latency-delta{display:inline-block;margin-left:6px;font-size:.6rem;padding:2px 6px;background:var(--bg-tertiary);border-radius:12px;opacity:.75}
  .group-mod{border:1px solid var(--glass-border);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03);padding:8px 10px}
  .group-mod[aria-expanded="false"] .group-body{display:none}
  .group-head{display:flex;align-items:center;gap:10px;font-size:.8rem;font-weight:600}
  .group-title{flex:1}
  .group-count{font-size:.65rem;opacity:.7}
  .group-types{display:flex;flex-wrap:wrap;gap:4px;margin:4px 0 6px 34px}
  .group-types .gt-pill{background:rgba(255,255,255,.07);border:1px solid var(--glass-border);border-radius:10px;padding:2px 6px;font-size:.6rem;display:inline-flex;align-items:center;gap:4px}
  html.high-contrast .group-types .gt-pill{background:#000;border-color:#fff}
  .group-mod.pinned{border-color:#f59e0b;box-shadow:0 0 0 1px rgba(245,158,11,.45)}
  .group-head .pin-btn{margin-left:4px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);border:0}
  /* Roles list extracted style */
  #rmRolesList{max-height:260px;overflow:auto;border:1px solid var(--glass-border);border-radius:8px;padding:6px;display:flex;flex-direction:column;gap:4px}
  #presetDiffModal .diff-add{background:rgba(16,185,129,.15);color:#34d399;padding:2px 4px;border-radius:4px}
  #presetDiffModal .diff-rem{background:rgba(239,68,68,.18);color:#f87171;padding:2px 4px;border-radius:4px;text-decoration:line-through}
  #presetDiffModal .diff-changed{background:rgba(245,158,11,.18);color:#fbbf24;padding:2px 4px;border-radius:4px}
  .preset-diff-modal-size{max-width:760px}
  .preset-diff-summary{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .preset-diff-details{max-height:300px;overflow:auto;border:1px solid var(--glass-border);border-radius:8px;padding:8px;font-size:.7rem;line-height:1.3}
  .preset-diff-actions{display:flex;flex-wrap:wrap;gap:8px}
    </style>
</body>
</html>
