<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IGNIS - Moderação</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    .card-pad{padding:16px}
    .gap-12{gap:12px}
    .mt-12{margin-top:12px}
    .mt-16{margin-top:16px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .mini-stat{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(255,255,255,.03)}
    .mini-stat .icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(124,58,237,.15);color:#c4b5fd}
    .mini-stat .value{font-size:1.2rem;font-weight:700}
    .feed-item{background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:12px;padding:12px;margin-bottom:8px}
    .feed-meta{color:var(--text-secondary);font-size:.9rem}
    .controls-row{display:flex;flex-wrap:wrap;gap:8px}
    .btn-toggle{padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,.04);color:var(--text-primary);cursor:pointer}
    .btn-toggle.active{background:rgba(124,58,237,.15);border-color:#7C3AED}
  </style>
  </head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand"><i class="fas fa-hammer"></i> Moderação</div>
      <div class="navbar-user">
        <span id="healthBadge" class="badge health-badge" title="Estado do sistema">
          <span id="health-mongo" class="dot dot-gray" title="DB"></span>
          <span id="health-discord" class="dot dot-gray" title="Discord"></span>
        </span>
        <img id="userAvatar" src="/default-avatar.svg" alt="Avatar" class="user-avatar">
        <span id="userName">Carregando...</span>
        <a id="btnDashboard" href="/dashboard" class="btn btn-glass"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/logout" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </nav>
  <main class="main-content">
    <div class="container">
      <section class="dashboard-section fade-in">
        <div class="section-header">
          <h1 class="section-title"><i class="fas fa-shield-alt"></i> Moderation Center</h1>
          <p class="text-secondary">Acompanhe ações de moderação em tempo real e filtre por tipo.</p>
        </div>

        <div class="glass-card card-pad">
          <div class="controls-row">
            <div class="input-group">
              <label for="window">Janela</label>
              <select id="window" class="input" title="Intervalo de tempo para contar eventos">
                <option value="1h">Última 1h</option>
                <option value="24h" selected>Últimas 24h</option>
                <option value="7d">Últimos 7 dias</option>
              </select>
            </div>
            <div class="input-group">
              <label for="q">Pesquisar</label>
              <input id="q" class="input" placeholder="Usuário, canal, motivo..." title="Texto para pesquisar nos logs" />
            </div>
            <div class="input-group">
              <label for="from">De</label>
              <input id="from" type="date" class="input" title="Data inicial" placeholder="YYYY-MM-DD" />
            </div>
            <div class="input-group">
              <label for="to">Até</label>
              <input id="to" type="date" class="input" title="Data final" placeholder="YYYY-MM-DD" />
            </div>
            <div class="input-group">
              <label for="userId">Usuário</label>
              <input id="userId" class="input" placeholder="ID do usuário" title="Filtrar por usuário (ID)" />
            </div>
            <div class="input-group">
              <label for="moderatorId">Moderador</label>
              <input id="moderatorId" class="input" placeholder="ID do moderador" title="Filtrar por moderador (executor)" />
            </div>
            <div class="input-group">
              <label for="channelId">Canal</label>
              <input id="channelId" class="input" placeholder="ID do canal" title="Filtrar por canal" />
            </div>
          </div>
          <div class="controls-row mt-12">
            <button class="btn-toggle active" data-filter="all"><i class="fas fa-list"></i> Todos</button>
            <button class="btn-toggle" data-filter="messages"><i class="fas fa-comment-dots"></i> Mensagens</button>
            <button class="btn-toggle" data-filter="members"><i class="fas fa-user"></i> Membros</button>
            <button class="btn-toggle" data-filter="voice"><i class="fas fa-microphone"></i> Voz</button>
            <button class="btn-toggle" data-filter="bans"><i class="fas fa-ban"></i> Banimentos</button>
            <span class="flex-1"></span>
            <button id="btnRefresh" class="btn btn-primary"><i class="fas fa-rotate"></i> Atualizar</button>
            <button id="btnAuto" class="btn btn-glass" aria-pressed="false"><i class="fas fa-play"></i> Auto</button>
            <div class="input-group">
              <label for="exportFormat">Exportar</label>
              <div class="inline-group">
                <select id="exportFormat" class="input" title="Formato de exportação">
                  <option value="csv" selected>CSV</option>
                  <option value="json">JSON</option>
                </select>
                <button id="btnExport" class="btn btn-glass"><i class="fas fa-download"></i> Exportar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="grid-auto mt-16" id="statsGrid">
          <div class="mini-stat"><div class="icon"><i class="fas fa-ban"></i></div><div><div class="label">Banimentos</div><div class="value" id="countBans">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-comment-slash"></i></div><div><div class="label">Mensagens apagadas</div><div class="value" id="countMsgDel">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-pen"></i></div><div><div class="label">Mensagens editadas</div><div class="value" id="countMsgEdit">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-users"></i></div><div><div class="label">Entradas/Saídas</div><div class="value" id="countJoinsLeaves">-</div></div></div>
          <div class="mini-stat"><div class="icon"><i class="fas fa-microphone"></i></div><div><div class="label">Eventos de voz</div><div class="value" id="countVoice">-</div></div></div>
        </div>

        <div class="glass-card card-pad mt-16">
          <h3 class="section-title"><i class="fas fa-stream"></i> Feed</h3>
          <div id="feed" class="mt-12"></div>
        </div>

        <div class="glass-card card-pad mt-16">
          <h3 class="section-title"><i class="fas fa-sitemap"></i> Hierarquia rápida</h3>
          <p class="text-secondary">Mover rapidamente cargos e canais. Use com cuidado.</p>
          <div class="grid-auto mt-12">
            <div>
              <h4 class="section-subtitle"><i class="fas fa-user-tag"></i> Cargos</h4>
              <div class="controls-row mt-8">
                <input id="roleIdQuick" class="input" placeholder="ID do cargo" title="Role ID" />
                <input id="roleSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnRoleUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnRoleDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
            </div>
            <div>
              <h4 class="section-subtitle"><i class="fas fa-hashtag"></i> Canais</h4>
              <div class="controls-row mt-8">
                <input id="channelIdQuick" class="input" placeholder="ID do canal" title="Channel ID" />
                <input id="channelSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnChanUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnChanDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
              <div class="controls-row mt-8">
                <input id="channelToCategory" class="input" placeholder="ID categoria alvo (opcional)" title="Categoria" />
                <button id="btnMoveToCategory" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Mover para categoria</button>
              </div>
            </div>
          </div>
          <div class="mt-12"><label><input type="checkbox" id="hierDryRun" checked/> Pré-visualizar antes de aplicar</label></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal para detalhes de evento de moderação -->
  <div id="moderationModal" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content ticket-modal moderation-modal">
      <div class="modal-header">
        <h2 id="modModalTitle">Detalhes do evento</h2>
  <button class="modal-close" aria-label="Fechar" onclick="(function(m){m.classList.add('modal-hidden');m.classList.remove('modal-visible');m.setAttribute('aria-hidden','true');})(document.getElementById('moderationModal'))">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modModalBody">Carregando...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4" crossorigin="anonymous"></script>
  <script>
    // Connect to socket server for live updates
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        const guildId = params.get('guildId');
        if (!guildId) return;
        const socket = io('/', { transports: ['websocket','polling'] });
        socket.on('connect', () => {
          try { socket.emit('joinGuild', guildId); } catch {}
        });
        socket.on('moderation_event', async (payload) => {
          // Debounced refresh to avoid spamming on bursts
          if (!window.__modRefreshPending) {
            window.__modRefreshPending = true;
            setTimeout(async () => {
              try {
                if (window.ModerationPage && typeof window.ModerationPage.refresh === 'function') {
                  await window.ModerationPage.refresh();
                } else {
                  // Fallback: soft reload of key widgets
                  const ev = new CustomEvent('moderation:refresh');
                  window.dispatchEvent(ev);
                }
              } finally { window.__modRefreshPending = false; }
            }, 800);
          }
        });
      } catch {}
    })();
  </script>
  <script src="/js/moderation.js"></script>
  <script>
    // Navbar user avatar/name & health
    (async()=>{ try{ const r = await fetch('/api/user'); const d = await r.json(); if(d?.success){ const a=document.getElementById('userAvatar'); const n=document.getElementById('userName'); if(a&&d.user.avatar) a.src=d.user.avatar; if(n) n.textContent=d.user.username; } }catch{} })();
    (async()=>{ const setTip=(t)=>{const hb=document.getElementById('healthBadge'); if(hb) hb.title=t;}; const dot=(el, st)=>{ if(!el) return; el.classList.remove('dot-green','dot-red','dot-gray'); el.classList.add(st==='ok'?'dot-green': st==='bad'?'dot-red':'dot-gray');}; try{ const r=await fetch('/api/health',{credentials:'same-origin'}); const h=await r.json(); dot(document.getElementById('health-mongo'), h.mongo==='connected'?'ok': (h.mongo==='disabled'?'gray':'bad')); dot(document.getElementById('health-discord'), h.discord?'ok':'bad'); setTip(`${h.mongo==='connected'?'DB: ligado': h.mongo==='disabled'?'DB: desativado':'DB: desligado'} • ${h.discord?'Discord: online':'Discord: offline'}`);}catch{}})();
  </script>
</body>
</html>
