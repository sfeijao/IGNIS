<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IGNIS - Moderação</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/moderation.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand"><i class="fas fa-hammer"></i> Moderação</div>
        <div class="navbar-user">
          <div class="btn-group-inline">
            <button id="themeToggle" class="btn btn-glass" title="Alternar tema"><i class="fas fa-moon"></i></button>
            <button id="contrastToggle" class="btn btn-glass" title="Alto contraste"><i class="fas fa-low-vision"></i></button>
          </div>
          <span id="healthBadge" class="badge health-badge" title="Estado do sistema">
            <span id="health-mongo" class="dot dot-gray" title="DB"></span>
            <span id="health-discord" class="dot dot-gray" title="Discord"></span>
          </span>
          <img id="userAvatar" src="/default-avatar.svg" alt="Avatar" class="user-avatar">
          <span id="userName">Carregando...</span>
          <a id="btnDashboard" href="/dashboard" class="btn btn-glass"><i class="fas fa-home"></i> Dashboard</a>
          <a href="/logout" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </nav>
    <main class="main-content">
      <div class="container">
        <section class="dashboard-section fade-in">
          <div class="section-header">
            <h1 class="section-title"><i class="fas fa-shield-alt"></i> Moderation Center</h1>
            <p class="text-secondary">Acompanhe ações de moderação em tempo real e filtre por tipo.</p>
          </div>

          <div class="glass-card card-pad">
            <div class="controls-row">
              <div class="input-group">
                <label for="window">Janela</label>
                <select id="window" class="input" title="Intervalo de tempo para contar eventos">
                  <option value="1h">Última 1h</option>
                  <option value="24h" selected>Últimas 24h</option>
                <!-- Modal para detalhes de evento de moderação -->
              </div>
            </template>
          </div>
          <div class="grid-auto mt-12">
            <div>
              <h4 class="section-subtitle"><i class="fas fa-user-tag"></i> Cargos</h4>
              <div class="controls-row mt-8">
                <input id="roleIdQuick" class="input" placeholder="ID do cargo" title="Role ID" />
                <input id="roleSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnRoleUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnRoleDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
            </div>
            <div>
              <h4 class="section-subtitle"><i class="fas fa-hashtag"></i> Canais</h4>
              <div class="controls-row mt-8">
                <input id="channelIdQuick" class="input" placeholder="ID do canal" title="Channel ID" />
                <input id="channelSteps" type="number" class="input w-120" value="1" min="1" title="Passos" />
                <button id="btnChanUp" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Subir</button>
                <button id="btnChanDown" class="btn btn-glass"><i class="fas fa-arrow-down"></i> Descer</button>
              </div>
              <div class="controls-row mt-8">
                <input id="channelToCategory" class="input" placeholder="ID categoria alvo (opcional)" title="Categoria" />
                <button id="btnMoveToCategory" class="btn btn-secondary"><i class="fas fa-folder-open"></i> Mover para categoria</button>
              </div>
            </div>
          </div>
          <div class="mt-12"><label><input type="checkbox" id="hierDryRun" checked/> Pré-visualizar antes de aplicar</label></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal para detalhes de evento de moderação -->
  <div id="moderationModal" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content ticket-modal moderation-modal">
      <div class="modal-header">
        <h2 id="modModalTitle">Detalhes do evento</h2>
  <button class="modal-close" aria-label="Fechar" onclick="(function(m){m.classList.add('modal-hidden');m.classList.remove('modal-visible');m.setAttribute('aria-hidden','true');})(document.getElementById('moderationModal'))">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modModalBody">Carregando...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4" crossorigin="anonymous"></script>
  <script>
    // Connect to socket server for live updates
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        const guildId = params.get('guildId');
        if (!guildId) return;
        const socket = io('/', { transports: ['websocket','polling'] });
        socket.on('connect', () => {
          try { socket.emit('joinGuild', guildId); } catch {}
        });
        socket.on('moderation_event', async (payload) => {
          // Debounced refresh to avoid spamming on bursts
          if (!window.__modRefreshPending) {
            window.__modRefreshPending = true;
            setTimeout(async () => {
              try {
                if (window.ModerationPage && typeof window.ModerationPage.handleLiveEvent === 'function') {
                  const handled = await window.ModerationPage.handleLiveEvent(payload);
                  if (!handled && typeof window.ModerationPage.refresh === 'function') {
                    await window.ModerationPage.refresh();
                  }
                } else {
                  // Fallback: soft reload of key widgets
                  const ev = new CustomEvent('moderation:refresh');
                  window.dispatchEvent(ev);
                }
              } finally { window.__modRefreshPending = false; }
            }, 800);
          }
        });
      } catch {}
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/js/moderation.js"></script>
  <!-- Modal Diff Presets -->
  <div id="presetDiffModal" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content preset-diff-modal-size">
      <div class="modal-header">
        <h2 id="presetDiffTitle">Diferenças de Presets</h2>
        <button class="modal-close" aria-label="Fechar" id="presetDiffClose">&times;</button>
      </div>
      <div class="modal-body" id="presetDiffBody">
        <p class="text-secondary" id="presetDiffIntro">Pré-visualização das alterações antes de aplicar.</p>
  <div id="presetDiffSummary" class="preset-diff-summary"></div>
  <div id="presetDiffDetails" class="preset-diff-details"></div>
  <div class="mt-12 preset-diff-actions">
          <button id="presetDiffMerge" class="btn btn-primary"><i class="fas fa-check"></i> Aplicar / Merge</button>
          <button id="presetDiffReplace" class="btn btn-glass"><i class="fas fa-exchange-alt"></i> Substituir Tudo</button>
          <button id="presetDiffCancel" class="btn btn-danger"><i class="fas fa-times"></i> Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Shortcut Help Overlay -->
  <div id="shortcutOverlay" class="modal-overlay modal-hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content modal-wide">
      <div class="modal-header">
        <h2>Atalhos</h2>
        <button class="modal-close" aria-label="Fechar" onclick="(function(m){m.classList.add('modal-hidden');m.classList.remove('modal-visible');m.setAttribute('aria-hidden','true');})(document.getElementById('shortcutOverlay'))">&times;</button>
      </div>
      <div class="modal-body">
        <ul class="shortcut-list">
          <li><kbd>?</kbd> / <kbd>Shift</kbd> + <kbd>/</kbd> — Mostrar/Ocultar esta ajuda</li>
          <li><kbd>F</kbd> — Focar campo de pesquisa</li>
          <li><kbd>R</kbd> — Atualizar (resumo + feed)</li>
          <li><kbd>A</kbd> — Alternar Auto refresh</li>
          <li><kbd>T</kbd> — Alternar tema claro/escuro</li>
          <li><kbd>C</kbd> — Alternar alto contraste</li>
          <li><kbd>1</kbd> / <kbd>2</kbd> / <kbd>3</kbd> / <kbd>4</kbd> / <kbd>5</kbd> — Alternar filtros (Todos, Mensagens, Membros, Voz, Banimentos)</li>
          <li><kbd>Esc</kbd> — Fechar modais</li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    // Theme toggle (light/dark) persisted in localStorage
    (function(){
      try {
        const key='ui-theme';
        const apply=(t)=>{ document.documentElement.setAttribute('data-theme', t); };
        const saved = localStorage.getItem(key) || 'dark';
        apply(saved);
        const btn = document.getElementById('themeToggle');
        const setIcon = ()=>{ btn.innerHTML = (document.documentElement.getAttribute('data-theme')==='light')? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; };
        setIcon();
        btn?.addEventListener('click', ()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; const next = (cur==='dark')?'light':'dark'; apply(next); localStorage.setItem(key,next); setIcon(); });
      } catch {}
    })();
    // Density/Theme selectors persisted and applied as html classes
    (function(){
      try {
        const densKey = 'mod-feed-density';
        const themeKey = 'mod-feed-theme';
        const html = document.documentElement;
        const applyDensity = (v)=>{
          html.classList.toggle('feed-density-compact', v==='compact');
        };
        const applyTheme = (v)=>{
          html.classList.toggle('feed-theme-type-colored', v==='type-colored');
        };
        const dSel = document.getElementById('densitySelect');
        const tSel = document.getElementById('themeSelect');
  let savedD = localStorage.getItem(densKey);
  let savedT = localStorage.getItem(themeKey);
  const validDensity = new Set(['comfortable','compact']);
  const validTheme = new Set(['subtle','type-colored']);
  if (!validDensity.has(savedD)) savedD = 'compact';
  if (!validTheme.has(savedT)) savedT = 'type-colored';
  applyDensity(savedD);
  applyTheme(savedT);
  if (dSel) dSel.value = savedD;
  if (tSel) tSel.value = savedT;
        dSel?.addEventListener('change', ()=>{ const v=dSel.value; localStorage.setItem(densKey, v); applyDensity(v); });
        tSel?.addEventListener('change', ()=>{ const v=tSel.value; localStorage.setItem(themeKey, v); applyTheme(v); });
      } catch {}
    })();
    // Navbar user avatar/name & health
    // Navbar user avatar/name & health
    (async()=>{ try{ const r = await fetch('/api/user'); const d = await r.json(); if(d?.success){ const a=document.getElementById('userAvatar'); const n=document.getElementById('userName'); if(a&&d.user.avatar) a.src=d.user.avatar; if(n) n.textContent=d.user.username; } }catch{} })();
    (async()=>{ const setTip=(t)=>{const hb=document.getElementById('healthBadge'); if(hb) hb.title=t;}; const dot=(el, st)=>{ if(!el) return; el.classList.remove('dot-green','dot-red','dot-gray'); el.classList.add(st==='ok'?'dot-green': st==='bad'?'dot-red':'dot-gray');}; try{ const r=await fetch('/api/health',{credentials:'same-origin'}); const h=await r.json(); dot(document.getElementById('health-mongo'), h.mongo==='connected'?'ok': (h.mongo==='disabled'?'gray':'bad')); dot(document.getElementById('health-discord'), h.discord?'ok':'bad'); setTip(`${h.mongo==='connected'?'DB: ligado': h.mongo==='disabled'?'DB: desativado':'DB: desligado'} • ${h.discord?'Discord: online':'Discord: offline'}`);}catch{}})();
    // Segmented control indicator logic
    (function(){
      const seg = document.getElementById('segFilters');
      const ind = document.getElementById('segIndicator');
      if(!seg || !ind) return;
      function sync(){
        const active = seg.querySelector('.btn-toggle.active');
        if(!active) return;
        const r = active.getBoundingClientRect();
        const rs = seg.getBoundingClientRect();
        const w = r.width;
        const x = r.left - rs.left;
        ind.style.width = w + 'px';
        ind.style.transform = `translateX(${x}px)`;
      }
      const ro = new ResizeObserver(()=>sync()); ro.observe(seg);
      new MutationObserver(()=>sync()).observe(seg,{attributes:true,subtree:true,attributeFilter:['class']});
      window.addEventListener('load', ()=> setTimeout(sync,60));
      window.addEventListener('resize', ()=> sync());
    })();
    // Enhance copy buttons with pulse feedback (delegated)
    (function(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.copy-summary, #btnCopyDetails');
        if(!btn) return;
        btn.classList.add('btn-pulse','pulsing');
        setTimeout(()=> btn.classList.remove('pulsing'), 700);
      });
    })();
    // Skeleton loader helper (if feed empty & loading class used by JS earlier)
    (function(){
      const feed = document.getElementById('feed');
      if(!feed) return;
      if(feed.children.length===0){
        const frag = document.createDocumentFragment();
        for(let i=0;i<4;i++){
          const sk = document.createElement('div'); sk.className='feed-skel';
          for(let b=0;b<3;b++){ const bar=document.createElement('div'); bar.className='bar skeleton-wave'; bar.style.width=(60+Math.random()*30)+'%'; sk.appendChild(bar);} frag.appendChild(sk);
        }
        feed.appendChild(frag);
      }
    })();
    // High contrast toggle persistence
    (function(){
      try {
        const key='ui-contrast';
        const html=document.documentElement;
        const btn=document.getElementById('contrastToggle');
        const apply=(v)=>{ html.classList.toggle('high-contrast', v==='on'); };
        const saved = localStorage.getItem(key)||'off';
        apply(saved);
        const setIcon=()=>{ btn.innerHTML = html.classList.contains('high-contrast')? '<i class="fas fa-eye"></i>' : '<i class="fas fa-low-vision"></i>'; };
        setIcon();
        btn?.addEventListener('click', ()=>{ const next = html.classList.contains('high-contrast')? 'off':'on'; apply(next); localStorage.setItem(key,next); setIcon(); });
      } catch {}
    })();
    // Global custom tooltip system (replaces native title tooltips for richer styling)
    (function(){
      const TIP_ATTR = 'data-tip';
      let tipEl = document.getElementById('globalTooltip');
      if(!tipEl){
        tipEl = document.createElement('div');
        tipEl.id = 'globalTooltip';
        document.body.appendChild(tipEl);
      }
      let currentTarget = null;
      let hideTimeout = null;
      const gap = 10;
      function showTip(target){
        if(!target) return;
        const raw = target.getAttribute(TIP_ATTR) || target.getAttribute('title');
        if(!raw) return;
        // If still has title attr, move it to data-tip to prevent native tooltip
        if(target.hasAttribute('title')){ target.setAttribute(TIP_ATTR, raw); target.removeAttribute('title'); }
        tipEl.textContent = raw;
        tipEl.setAttribute('data-visible','true');
        position(target);
      }
      function hideTip(){
        tipEl.removeAttribute('data-visible');
        currentTarget = null;
      }
      function position(target, evt){
        if(!target || !document.documentElement.contains(target)) { hideTip(); return; }
        let rect;
        try { rect = target.getBoundingClientRect(); } catch { hideTip(); return; }
        const ttRect = tipEl.getBoundingClientRect();
        const vw = window.innerWidth; const vh = window.innerHeight;
        let x = rect.left + (rect.width/2) - (ttRect.width/2);
        let y = rect.top - ttRect.height - gap;
        if(y < 4){ y = rect.bottom + gap; }
        if(x < 4) x = 4; if(x + ttRect.width > vw - 4) x = vw - ttRect.width - 4;
        if(y + ttRect.height > vh - 4) y = vh - ttRect.height - 4;
        tipEl.style.left = x + 'px';
        tipEl.style.top = y + 'px';
        if(evt){
          // If triggered by mousemove and near edges adjust quickly
        }
      }
      document.addEventListener('mouseover', (e)=>{
        const t = e.target.closest('[data-tip], [title]');
        if(!t){
            if(currentTarget){ hideTip(); }
            return;
        }
        if(t===currentTarget) return;
        currentTarget = t;
        clearTimeout(hideTimeout);
        showTip(t);
      });
      document.addEventListener('mousemove', (e)=>{
        if(!currentTarget) return;
        // Slight throttling via requestAnimationFrame
        if(!window.__tipRaf){
          window.__tipRaf = requestAnimationFrame(()=>{
            window.__tipRaf = null;
            if(!currentTarget || !document.documentElement.contains(currentTarget)) { hideTip(); return; }
            position(currentTarget, e);
          });
        }
      });
      document.addEventListener('mouseout', (e)=>{
        if(!currentTarget) return;
        if(!e.relatedTarget || !e.relatedTarget.closest('[data-tip], [title]')){
          hideTimeout = setTimeout(hideTip, 120);
        }
      });
      window.addEventListener('scroll', ()=>{ if(currentTarget) position(currentTarget); }, true);
      window.addEventListener('resize', ()=>{ if(currentTarget) position(currentTarget); });
    })();
    // Keyboard shortcuts overlay & handlers
    (function(){
      const overlay = document.getElementById('shortcutOverlay');
      const toggleOverlay = ()=>{
        if(!overlay) return;
        const vis = overlay.classList.contains('modal-visible');
        if(vis){ overlay.classList.add('modal-hidden'); overlay.classList.remove('modal-visible'); overlay.setAttribute('aria-hidden','true'); }
        else { overlay.classList.remove('modal-hidden'); overlay.classList.add('modal-visible'); overlay.setAttribute('aria-hidden','false'); }
      };
      document.addEventListener('keydown', (e)=>{
        if(e.key === '/' && e.shiftKey){ e.preventDefault(); toggleOverlay(); return; }
        if(e.key === '?' ){ e.preventDefault(); toggleOverlay(); return; }
        if(e.key === 'Escape'){
          if(overlay?.classList.contains('modal-visible')){ toggleOverlay(); return; }
          const mod = document.getElementById('moderationModal');
          if(mod?.classList.contains('modal-visible')){ mod.classList.add('modal-hidden'); mod.classList.remove('modal-visible'); mod.setAttribute('aria-hidden','true'); }
        }
        if(e.target && (['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName))) return;
        switch(e.key){
          case 'F': case 'f': { const q=document.getElementById('q'); if(q){ q.focus(); q.select(); } break; }
          case 'R': case 'r': { const btn=document.getElementById('btnRefresh'); btn?.click(); break; }
          case 'A': case 'a': { const btn=document.getElementById('btnAuto'); btn?.click(); break; }
          case 'T': case 't': { const btn=document.getElementById('themeToggle'); btn?.click(); break; }
          case 'C': case 'c': { const btn=document.getElementById('contrastToggle'); btn?.click(); break; }
          case '1': { document.querySelector('[data-filter="all"]')?.click(); break; }
          case '2': { document.querySelector('[data-filter="messages"]')?.click(); break; }
          case '3': { document.querySelector('[data-filter="members"]')?.click(); break; }
          case '4': { document.querySelector('[data-filter="voice"]')?.click(); break; }
          case '5': { document.querySelector('[data-filter="bans"]')?.click(); break; }
        }
      });
    })();
  </script>
</body>
</html>
