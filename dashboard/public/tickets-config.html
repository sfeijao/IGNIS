<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IGNIS - Configurar Sistema de Tickets</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand"><i class="fas fa-ticket-alt"></i> Configurar Tickets</div>
      <div class="navbar-user">
        <a href="/dashboard" class="btn btn-glass btn-sm" title="Voltar ao dashboard"><i class="fas fa-arrow-left"></i> Voltar</a>
  <span id="healthBadge" class="badge health-badge" title="Estado do sistema">
          <span id="health-mongo" class="dot dot-gray" title="DB"></span>
          <span id="health-discord" class="dot dot-gray" title="Discord"></span>
        </span>
        <img id="userAvatar" src="/default-avatar.svg" alt="Avatar" class="user-avatar">
        <span id="userName">Carregando...</span>
    <a href="/dashboard" class="btn btn-glass"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/logout" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </nav>
  <main class="main-content">
    <div class="container">
      <section class="dashboard-section fade-in">
        <div class="section-header">
          <h1 class="section-title"><i class="fas fa-sliders-h"></i> Sistema de Tickets</h1>
          <p class="text-secondary">Define categorias, tipos, SLA e mensagens padr√£o.</p>
        </div>

        <div class="grid grid-2 gap-12">
          <!-- Painel e Acesso -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-door-open"></i> Painel & Acesso</h3>
            <div class="grid grid-2 gap-12">
              <div>
                <label>Canal do painel</label>
                <select id="panelChannel" class="input" title="Canal onde o painel ser√° publicado"></select>
                <p class="text-muted mt-6 text-sm">Escolhe o canal onde o painel principal de tickets ser√° enviado.</p>
              </div>
              <div>
                <label>Categoria para tickets</label>
                <div class="grid gap-8">
                  <select id="ticketsCategory" class="input" title="Categoria onde os tickets ser√£o criados (opcional)"></select>
                  <div class="grid grid-2 gap-8">
                    <input id="newCategoryName" class="input" placeholder="Criar nova categoria (ex.: üìÅ TICKETS)" />
                    <button id="btnCreateCategory" class="btn btn-glass"><i class="fas fa-plus"></i> Criar Categoria</button>
                  </div>
                </div>
                <p class="text-muted mt-6 text-sm">Se selecionares, os canais de ticket ser√£o organizados nesta categoria. Podes tamb√©m criar uma nova categoria.</p>
              </div>
              <div class="full">
                <label>Cargos com acesso inicial</label>
                <select id="accessRoles" multiple class="input" title="Cargos que ter√£o acesso por padr√£o aos tickets"></select>
              </div>
              <div class="full">
                <label>Canal de logs de tickets</label>
                <select id="logsChannel" class="input" title="Canal onde a√ß√µes de tickets ser√£o registadas"></select>
                <p class="text-muted mt-6 text-sm">Seleciona onde notifica√ß√µes (abrir/fechar, etc.) ser√£o enviadas quando n√£o existe webhook dedicado.</p>
              </div>
            </div>
          </div>
          <!-- Categorias autom√°ticas -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-folder-tree"></i> Categorias autom√°ticas</h3>
            <div class="grid grid-2 gap-8">
              <label class="switch"><input type="checkbox" id="catSupport"><span>Suporte</span></label>
              <label class="switch"><input type="checkbox" id="catReport"><span>Den√∫ncia</span></label>
              <label class="switch"><input type="checkbox" id="catPartner"><span>Parceria</span></label>
              <label class="switch"><input type="checkbox" id="catStaff"><span>Staff</span></label>
            </div>
          </div>
          <!-- Tipos de ticket -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-list-ul"></i> Tipos de ticket</h3>
            <div class="grid grid-2 gap-8">
              <label class="switch"><input type="checkbox" id="typeDm"><span>DM staff</span></label>
              <label class="switch"><input type="checkbox" id="typeChannel"><span>Canal privado</span></label>
              <label class="switch"><input type="checkbox" id="typeForm"><span>Formul√°rio</span></label>
            </div>
          </div>

          <!-- Auto-atribui√ß√£o & SLA -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-people-arrows"></i> Atribui√ß√£o & SLA</h3>
            <div class="grid grid-2 gap-12">
              <div>
                <label>M√©todo de atribui√ß√£o</label>
                <select id="autoAssign" class="input" title="M√©todo de atribui√ß√£o de tickets">
                  <option value="first">Quem pega primeiro</option>
                  <option value="free">Quem est√° livre</option>
                  <option value="random">Aleat√≥rio</option>
                </select>
              </div>
              <div>
                <label>SLA (minutos para 1¬™ resposta)</label>
                <input id="slaMinutes" class="input" type="number" min="1" max="1440" value="15" title="Minutos para primeira resposta" placeholder="Minutos" />
              </div>
            </div>
          </div>

          <!-- Modelo padr√£o dos pain√©is -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-palette"></i> Modelo padr√£o dos pain√©is</h3>
            <div class="grid gap-8">
              <div class="grid grid-2 gap-8">
                <div>
                  <label>Tema do painel</label>
                  <select id="theme" class="input" title="Tema usado ao renderizar o painel">
                    <option value="dark">Escuro</option>
                    <option value="light">Claro</option>
                  </select>
                </div>
                <div>
                  <label>Cor do embed (opcional)</label>
                  <input id="embedColor" class="input" placeholder="#7C3AED" title="Hexadecimal #RRGGBB" pattern="#?[0-9a-fA-F]{6}" />
                </div>
              </div>
              <div>
                <label>Template por omiss√£o</label>
                <select id="defaultTemplate" class="input" title="Modelo usado ao criar novos pain√©is se n√£o for escolhido outro">
                  <option value="classic">Cl√°ssico</option>
                  <option value="compact">Compacto</option>
                  <option value="premium">Premium</option>
                  <option value="minimal">Minimal</option>
                </select>
                <p class="text-muted mt-6 text-sm">
                  Este modelo ser√° aplicado quando criar novos pain√©is sem escolher um template espec√≠fico.
                </p>
              </div>
            </div>
          </div>

          <!-- Mensagem inicial & Fecho -->
          <div class="glass-card card-pad">
            <h3 class="mb-8"><i class="fas fa-message"></i> Mensagens</h3>
            <div class="grid gap-8">
              <div>
                <label>Mensagem inicial (placeholders: {user}, {ticket_id})</label>
                <textarea id="welcomeMsg" class="input" rows="4" placeholder="Ol√° {user}, obrigado por abrir o ticket #{ticket_id}! Explique-nos o seu problema."></textarea>
              </div>
              <div>
                <label>Fechar com motivo + transcript opcional</label>
                <label class="switch"><input type="checkbox" id="closeReason"><span>Exigir motivo ao fechar</span></label>
                <label class="switch"><input type="checkbox" id="closeTranscript"><span>Gerar transcript por padr√£o</span></label>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-12">
          <div class="grid grid-3 gap-12">
            <button id="btnSave" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Configura√ß√µes</button>
            <button id="btnPreview" class="btn btn-glass"><i class="fas fa-eye"></i> Pr√©-visualizar Painel</button>
            <button id="btnPublish" class="btn btn-glass"><i class="fas fa-bullhorn"></i> Publicar/Atualizar Painel</button>
          </div>
        </div>
      </section>
    </div>
  </main>
  <script src="/js/utils/fetch-cache.js"></script>
  <script src="/js/utils/multiselect.js"></script>
  <script src="/js/tickets-config.js"></script>
  <style>
    .card-pad{padding:16px}
    .gap-12{gap:12px}
    .gap-8{gap:8px}
    .mb-8{margin-bottom:8px}
    .mt-6{margin-top:6px}
    .text-sm{font-size:.9rem}
    .mt-12{margin-top:12px}
    .full{grid-column: 1 / -1}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input[type=checkbox]{appearance:none;width:42px;height:24px;border-radius:999px;background:rgba(255,255,255,0.1);position:relative;outline:none;cursor:pointer;transition:.2s}
    .switch input[type=checkbox]:checked{background:#22c55e}
    .switch input[type=checkbox]::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
    .switch input[type=checkbox]:checked::after{transform:translateX(18px)}
  </style>
  <script>
    // Badge de sa√∫de reutilizado
    (async () => {
      const setTip = (text) => { const hb = document.getElementById('healthBadge'); if (hb) hb.title = text; };
      const dot = (el, state) => { if (!el) return; el.classList.remove('dot-green','dot-red','dot-gray'); el.classList.add(state === 'ok' ? 'dot-green' : state === 'bad' ? 'dot-red' : 'dot-gray'); };
      try {
        const r = await fetch('/api/health', { credentials: 'same-origin' });
        const h = await r.json();
        dot(document.getElementById('health-mongo'), h.mongo === 'connected' ? 'ok' : (h.mongo === 'disabled' ? 'gray' : 'bad'));
        dot(document.getElementById('health-discord'), h.discord ? 'ok' : 'bad');
        setTip(`${h.mongo === 'connected' ? 'DB: ligado' : h.mongo === 'disabled' ? 'DB: desativado' : 'DB: desligado'} ‚Ä¢ ${h.discord ? 'Discord: online' : 'Discord: offline'}`);
      } catch {}
    })();
  </script>
  
</body>
</html>
