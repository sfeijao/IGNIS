"use client"

import { useEffect, useMemo, useState } from 'react'

export type Lang = 'pt' | 'en'

const STRINGS: Record<Lang, Record<string, string>> = {
  pt: {
    'roles.title': 'Gestão de Cargos',
    'roles.selectGuild': 'Selecione um servidor para gerir cargos.',
    'roles.name': 'Nome',
    'roles.color': 'Cor (#RRGGBB)',
    'roles.create': 'Criar',
    'roles.refresh': 'Atualizar',
    'roles.loading': 'A carregar…',
    'roles.remove.confirm': 'Remover cargo?',
    'roles.remove': 'Remover',
    'roles.up': 'Subir',
    'roles.down': 'Descer',
    'roles.selectToEdit': 'Selecione um cargo para editar permissões.',
    'roles.showSeparately': 'Mostrar separado (hoist)',
    'roles.mentionable': 'Mencionável',
    'roles.permissions': 'Permissões',
    'roles.permissions.note': 'Nota: selecionar Administrador concede todas as permissões. Tenha cuidado.',
    'roles.permissions.search': 'Procurar permissões…',
    'roles.permissions.selectAll': 'Selecionar tudo',
    'roles.permissions.clearAll': 'Limpar',
    'roles.save': 'Guardar alterações',
    'roles.updated': 'Cargo atualizado',
    'roles.load.failed': 'Falha ao carregar cargos',
    'roles.role.load.failed': 'Falha ao carregar cargo',
    'roles.move.failed': 'Falha ao mover cargo',
    // Permission labels
    'perm.Administrator': 'Administrador',
    'perm.ManageGuild': 'Gerir Servidor',
    'perm.ManageRoles': 'Gerir Cargos',
    'perm.ManageChannels': 'Gerir Canais',
    'perm.ViewAuditLog': 'Ver Registo de Auditoria',
    'perm.KickMembers': 'Expulsar Membros',
    'perm.BanMembers': 'Banir Membros',
    'perm.ModerateMembers': 'Silenciar/Timeout',
    'perm.ManageNicknames': 'Gerir Nomes',
    'perm.ChangeNickname': 'Alterar Próprio Nome',
    'perm.ManageMessages': 'Gerir Mensagens',
    'perm.MentionEveryone': 'Mencionar @everyone',
    'perm.ManageWebhooks': 'Gerir Webhooks',
    'perm.ManageEmojisAndStickers': 'Gerir Emojis/Stickers',
    'perm.ManageEvents': 'Gerir Eventos',
    'perm.ManageThreads': 'Gerir Threads',
    'perm.CreatePublicThreads': 'Criar Threads Públicas',
    'perm.CreatePrivateThreads': 'Criar Threads Privadas',
    'perm.SendMessages': 'Enviar Mensagens',
    'perm.SendTTSMessages': 'Enviar Mensagens TTS',
    'perm.EmbedLinks': 'Inserir Links',
    'perm.AttachFiles': 'Anexar Ficheiros',
    'perm.ReadMessageHistory': 'Ler Histórico',
    'perm.UseExternalEmojis': 'Usar Emojis Externos',
    'perm.UseExternalStickers': 'Usar Stickers Externos',
    'perm.AddReactions': 'Adicionar Reações',
    'perm.UseApplicationCommands': 'Usar Comandos de App',
    'perm.SendMessagesInThreads': 'Enviar em Threads',
    'perm.ViewChannel': 'Ver Canais',
    'perm.Connect': 'Conectar Voz',
    'perm.Speak': 'Falar',
    'perm.MuteMembers': 'Silenciar',
    'perm.DeafenMembers': 'Ensurdecer',
    'perm.MoveMembers': 'Mover Membros',
    'perm.UseVAD': 'Usar Deteção de Voz',
    'perm.PrioritySpeaker': 'Orador Prioritário',
    'perm.Stream': 'Transmitir (Stream)',
    'perm.RequestToSpeak': 'Pedir para Falar',
    'perm.UseEmbeddedActivities': 'Usar Actividades Integradas',
    'perm.ViewGuildInsights': 'Ver Estatísticas do Servidor',
    'perm.UseSoundboard': 'Usar Soundboard',
    'perm.UseExternalSounds': 'Usar Sons Externos',
    'perm.ViewCreatorMonetizationAnalytics': 'Ver Analytics de Monetização',
    'perm.SendVoiceMessages': 'Enviar Mensagens de Voz',
    'perm.CreateInstantInvite': 'Criar Convites Instantâneos',
  },
  en: {
    'roles.title': 'Role Management',
    'roles.selectGuild': 'Select a server to manage roles.',
    'roles.name': 'Name',
    'roles.color': 'Color (#RRGGBB)',
    'roles.create': 'Create',
    'roles.refresh': 'Refresh',
    'roles.loading': 'Loading…',
    'roles.remove.confirm': 'Remove role?',
    'roles.remove': 'Remove',
    'roles.up': 'Up',
    'roles.down': 'Down',
    'roles.selectToEdit': 'Select a role to edit permissions.',
    'roles.showSeparately': 'Display separately (hoist)',
    'roles.mentionable': 'Mentionable',
    'roles.permissions': 'Permissions',
    'roles.permissions.note': 'Note: Administrator grants all permissions. Be careful.',
    'roles.permissions.search': 'Search permissions…',
    'roles.permissions.selectAll': 'Select all',
    'roles.permissions.clearAll': 'Clear',
    'roles.save': 'Save changes',
    'roles.updated': 'Role updated',
    'roles.load.failed': 'Failed to load roles',
    'roles.role.load.failed': 'Failed to load role',
    'roles.move.failed': 'Failed to move role',
    // Permission labels
    'perm.Administrator': 'Administrator',
    'perm.ManageGuild': 'Manage Server',
    'perm.ManageRoles': 'Manage Roles',
    'perm.ManageChannels': 'Manage Channels',
    'perm.ViewAuditLog': 'View Audit Log',
    'perm.KickMembers': 'Kick Members',
    'perm.BanMembers': 'Ban Members',
    'perm.ModerateMembers': 'Timeout Members',
    'perm.ManageNicknames': 'Manage Nicknames',
    'perm.ChangeNickname': 'Change Own Nickname',
    'perm.ManageMessages': 'Manage Messages',
    'perm.MentionEveryone': 'Mention @everyone',
    'perm.ManageWebhooks': 'Manage Webhooks',
    'perm.ManageEmojisAndStickers': 'Manage Emojis/Stickers',
    'perm.ManageEvents': 'Manage Events',
    'perm.ManageThreads': 'Manage Threads',
    'perm.CreatePublicThreads': 'Create Public Threads',
    'perm.CreatePrivateThreads': 'Create Private Threads',
    'perm.SendMessages': 'Send Messages',
    'perm.SendTTSMessages': 'Send TTS Messages',
    'perm.EmbedLinks': 'Embed Links',
    'perm.AttachFiles': 'Attach Files',
    'perm.ReadMessageHistory': 'Read Message History',
    'perm.UseExternalEmojis': 'Use External Emojis',
    'perm.UseExternalStickers': 'Use External Stickers',
    'perm.AddReactions': 'Add Reactions',
    'perm.UseApplicationCommands': 'Use Application Commands',
    'perm.SendMessagesInThreads': 'Send in Threads',
    'perm.ViewChannel': 'View Channels',
    'perm.Connect': 'Connect (Voice)',
    'perm.Speak': 'Speak',
    'perm.MuteMembers': 'Mute Members',
    'perm.DeafenMembers': 'Deafen Members',
    'perm.MoveMembers': 'Move Members',
    'perm.UseVAD': 'Use Voice Activity',
    'perm.PrioritySpeaker': 'Priority Speaker',
    'perm.Stream': 'Stream',
    'perm.RequestToSpeak': 'Request to Speak',
    'perm.UseEmbeddedActivities': 'Use Embedded Activities',
    'perm.ViewGuildInsights': 'View Server Insights',
    'perm.UseSoundboard': 'Use Soundboard',
    'perm.UseExternalSounds': 'Use External Sounds',
    'perm.ViewCreatorMonetizationAnalytics': 'View Creator Monetization Analytics',
    'perm.SendVoiceMessages': 'Send Voice Messages',
    'perm.CreateInstantInvite': 'Create Instant Invites',
  }
}

export function useI18n() {
  const [lang, setLang] = useState<Lang>('pt')
  useEffect(() => {
    const saved = typeof window !== 'undefined' ? (localStorage.getItem('lang') as Lang | null) : null
    if (saved === 'pt' || saved === 'en') setLang(saved)
  }, [])
  useEffect(() => {
    if (typeof window !== 'undefined') localStorage.setItem('lang', lang)
  }, [lang])
  const t = useMemo(() => {
    return (key: string) => STRINGS[lang][key] ?? key
  }, [lang])
  return { t, lang, setLang }
}

export const PERMISSION_KEYS: Array<{ key: string; danger?: boolean }> = [
  { key: 'Administrator', danger: true },
  { key: 'ManageGuild' },
  { key: 'ManageRoles' },
  { key: 'ManageChannels' },
  { key: 'ViewAuditLog' },
  { key: 'KickMembers' },
  { key: 'BanMembers' },
  { key: 'ModerateMembers' },
  { key: 'ManageNicknames' },
  { key: 'ChangeNickname' },
  { key: 'ManageMessages' },
  { key: 'MentionEveryone' },
  { key: 'ManageWebhooks' },
  { key: 'ManageEmojisAndStickers' },
  { key: 'ManageEvents' },
  { key: 'ManageThreads' },
  { key: 'CreatePublicThreads' },
  { key: 'CreatePrivateThreads' },
  { key: 'SendMessages' },
  { key: 'SendTTSMessages' },
  { key: 'EmbedLinks' },
  { key: 'AttachFiles' },
  { key: 'ReadMessageHistory' },
  { key: 'UseExternalEmojis' },
  { key: 'UseExternalStickers' },
  { key: 'AddReactions' },
  { key: 'UseApplicationCommands' },
  { key: 'SendMessagesInThreads' },
  { key: 'ViewChannel' },
  { key: 'Connect' },
  { key: 'Speak' },
  { key: 'MuteMembers' },
  { key: 'DeafenMembers' },
  { key: 'MoveMembers' },
  { key: 'UseVAD' },
  { key: 'PrioritySpeaker' },
  { key: 'Stream' },
  { key: 'RequestToSpeak' },
  { key: 'UseEmbeddedActivities' },
  { key: 'ViewGuildInsights' },
  { key: 'UseSoundboard' },
  { key: 'UseExternalSounds' },
  { key: 'ViewCreatorMonetizationAnalytics' },
  { key: 'SendVoiceMessages' },
  { key: 'CreateInstantInvite' },
]

// Bit mapping for decoding server-provided bitfield strings (Discord v14 flags)
export const PERMISSION_BITS: Record<string, bigint> = {
  CreateInstantInvite: 1n,
  KickMembers: 2n,
  BanMembers: 4n,
  Administrator: 8n,
  ManageChannels: 16n,
  ManageGuild: 32n,
  AddReactions: 64n,
  ViewAuditLog: 128n,
  PrioritySpeaker: 256n,
  Stream: 512n,
  ViewChannel: 1024n,
  SendMessages: 2048n,
  SendTTSMessages: 4096n,
  ManageMessages: 8192n,
  EmbedLinks: 16384n,
  AttachFiles: 32768n,
  ReadMessageHistory: 65536n,
  MentionEveryone: 131072n,
  UseExternalEmojis: 262144n,
  ViewGuildInsights: 524288n,
  Connect: 1048576n,
  Speak: 2097152n,
  MuteMembers: 4194304n,
  DeafenMembers: 8388608n,
  MoveMembers: 16777216n,
  UseVAD: 33554432n,
  ChangeNickname: 67108864n,
  ManageNicknames: 134217728n,
  ManageRoles: 268435456n,
  ManageWebhooks: 536870912n,
  ManageEmojisAndStickers: 1073741824n,
  UseApplicationCommands: 2147483648n,
  RequestToSpeak: 4294967296n,
  ManageEvents: 8589934592n,
  ManageThreads: 17179869184n,
  CreatePublicThreads: 34359738368n,
  CreatePrivateThreads: 68719476736n,
  UseExternalStickers: 137438953472n,
  SendMessagesInThreads: 274877906944n,
  UseEmbeddedActivities: 549755813888n,
  ModerateMembers: 1099511627776n,
  ViewCreatorMonetizationAnalytics: 2199023255552n,
  UseSoundboard: 4398046511104n,
  UseExternalSounds: 17592186044416n,
  SendVoiceMessages: 35184372088832n,
}
