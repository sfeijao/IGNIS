<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ DiagnÃ³stico Dashboard YSNM</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Inline debug styles moved to css/style.css -->
</head>
<body>
    <script src="/js/frontend-helpers.js"></script>
    <div class="container">
        <h1>ğŸ”§ DiagnÃ³stico Dashboard YSNM</h1>
    <p class="muted-center">
            Teste profundo para identificar onde o dashboard falha
        </p>

        <div class="grid">
            <!-- Teste de AutenticaÃ§Ã£o -->
            <div class="test-section">
                <h3>ğŸ” Teste de AutenticaÃ§Ã£o</h3>
                <button class="btn" onclick="testAuth()">Testar Auth</button>
                <span id="auth-status" class="status loading">Aguardando...</span>
                <div id="auth-result" class="result hidden"></div>
            </div>

            <!-- Teste de Guilds -->
            <div class="test-section">
                <h3>ğŸ  Teste de Guilds</h3>
                <button class="btn" onclick="testGuilds()">Testar Guilds</button>
                <span id="guilds-status" class="status loading">Aguardando...</span>
                <div id="guilds-result" class="result hidden"></div>
            </div>

            <!-- Teste de JavaScript -->
            <div class="test-section">
                <h3>âš™ï¸ Teste JavaScript</h3>
                <button class="btn" onclick="testJavaScript()">Testar JS</button>
                <span id="js-status" class="status loading">Aguardando...</span>
                <div id="js-result" class="result hidden"></div>
            </div>

            <!-- Teste de Console -->
            <div class="test-section">
                <h3>ğŸ› Console Debug</h3>
                <button class="btn" onclick="startConsoleMonitor()">Monitorar Console</button>
                <span id="console-status" class="status loading">Aguardando...</span>
            </div>
        </div>

        <!-- Log em Tempo Real -->
        <div class="test-section">
            <h3>ğŸ“Š Log de Atividades</h3>
            <button class="btn" onclick="clearLog()">Limpar Log</button>
            <div id="activity-log" class="log"></div>
        </div>

        <!-- SimulaÃ§Ã£o do Dashboard -->
        <div class="test-section">
            <h3>ğŸ® SimulaÃ§Ã£o Dashboard</h3>
            <button class="btn" onclick="simulateDashboard()">Simular Carregamento</button>
            <span id="sim-status" class="status loading">Aguardando...</span>
            <div id="sim-result" class="result hidden"></div>
        </div>
    </div>

    <script>
        // Log system
        function addLog(message, type = 'info') {
            const log = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timeSpan = document.createElement('span');
            timeSpan.style.color = '#64748B';
            timeSpan.textContent = `[${timestamp}] `;
            entry.appendChild(timeSpan);
            const msgNode = document.createTextNode(message);
            entry.appendChild(msgNode);
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            const _act = document.getElementById('activity-log'); if (_act) { while (_act.firstChild) _act.removeChild(_act.firstChild); }
            addLog('Log limpo', 'info');
        }

        function updateStatus(testName, success, message = '') {
            const statusEl = document.getElementById(`${testName}-status`);
            const resultEl = document.getElementById(`${testName}-result`);
            
            statusEl.className = `status ${success ? 'success' : 'error'}`;
            statusEl.textContent = success ? 'âœ… Sucesso' : 'âŒ Erro';
            
            if (message) {
                resultEl.style.display = 'block';
                resultEl.textContent = message;
            }
        }

        // Teste de AutenticaÃ§Ã£o
        async function testAuth() {
            addLog('ğŸ” Iniciando teste de autenticaÃ§Ã£o...', 'info');
            
            try {
                // Teste 1: /api/user
                addLog('Testando /api/user...', 'info');
                const userResponse = await fetch('/api/user');
                const userData = await userResponse.json();
                
                addLog(`Status: ${userResponse.status}`, userResponse.ok ? 'success' : 'error');
                addLog(`Resposta: ${JSON.stringify(userData, null, 2)}`, 'info');
                
                if (userData.success) {
                    updateStatus('auth', true, `âœ… UsuÃ¡rio autenticado: ${userData.user?.username || 'Developer'}`);
                    addLog('âœ… AutenticaÃ§Ã£o funcionando!', 'success');
                } else {
                    updateStatus('auth', false, `âŒ Falha na autenticaÃ§Ã£o: ${userData.error || 'Erro desconhecido'}`);
                    addLog('âŒ Falha na autenticaÃ§Ã£o', 'error');
                }
            } catch (error) {
                updateStatus('auth', false, `âŒ Erro de rede: ${error.message}`);
                addLog(`âŒ Erro de rede: ${error.message}`, 'error');
            }
        }

        // Teste de Guilds
        async function testGuilds() {
            addLog('ğŸ  Iniciando teste de guilds...', 'info');
            
            try {
                const response = await fetch('/api/guilds');
                const data = await response.json();
                
                addLog(`Status: ${response.status}`, response.ok ? 'success' : 'error');
                addLog(`Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    const guilds = data.guilds || [];
                    updateStatus('guilds', true, `âœ… ${guilds.length} servidor(es) encontrado(s)\n\n${JSON.stringify(data, null, 2)}`);
                    addLog(`âœ… ${guilds.length} servidor(es) carregado(s)`, 'success');
                } else {
                    updateStatus('guilds', false, `âŒ Erro: ${data.error || 'Falha na API'}`);
                    addLog(`âŒ Erro ao carregar guilds: ${data.error}`, 'error');
                }
            } catch (error) {
                updateStatus('guilds', false, `âŒ Erro de rede: ${error.message}`);
                addLog(`âŒ Erro de rede: ${error.message}`, 'error');
            }
        }

        // Teste de JavaScript
        function testJavaScript() {
            addLog('âš™ï¸ Testando JavaScript bÃ¡sico...', 'info');
            
            try {
                // Teste 1: Verificar se console funciona
                console.log('ğŸ§ª Teste de console');
                addLog('âœ… Console.log funcionando', 'success');
                
                // Teste 2: Verificar localStorage
                try {
                    localStorage.setItem('test', 'value');
                    const test = localStorage.getItem('test');
                    localStorage.removeItem('test');
                    addLog('âœ… LocalStorage funcionando', 'success');
                } catch (e) {
                    addLog('âŒ LocalStorage com problemas', 'error');
                }
                
                // Teste 3: Verificar fetch API
                if (typeof fetch === 'function') {
                    addLog('âœ… Fetch API disponÃ­vel', 'success');
                } else {
                    addLog('âŒ Fetch API nÃ£o disponÃ­vel', 'error');
                }
                
                // Teste 4: Verificar DOM
                if (document.getElementById && document.querySelector) {
                    addLog('âœ… DOM API funcionando', 'success');
                } else {
                    addLog('âŒ DOM API com problemas', 'error');
                }
                
                updateStatus('js', true, 'âœ… JavaScript bÃ¡sico funcionando corretamente');
                addLog('âœ… Todos os testes JavaScript passaram', 'success');
                
            } catch (error) {
                updateStatus('js', false, `âŒ Erro JavaScript: ${error.message}`);
                addLog(`âŒ Erro JavaScript: ${error.message}`, 'error');
            }
        }

        // Monitor de Console
        function startConsoleMonitor() {
            addLog('ğŸ› Iniciando monitor de console...', 'info');
            
            // Capturar console.log
            const originalLog = console.log;
            console.log = function(...args) {
                addLog(`[LOG] ${args.join(' ')}`, 'info');
                originalLog.apply(console, args);
            };
            
            // Capturar console.error
            const originalError = console.error;
            console.error = function(...args) {
                addLog(`[ERROR] ${args.join(' ')}`, 'error');
                originalError.apply(console, args);
            };
            
            // Capturar console.warn
            const originalWarn = console.warn;
            console.warn = function(...args) {
                addLog(`[WARN] ${args.join(' ')}`, 'warning');
                originalWarn.apply(console, args);
            };
            
            // Capturar erros globais
            window.addEventListener('error', function(event) {
                addLog(`[GLOBAL ERROR] ${event.error?.message || event.message} em ${event.filename}:${event.lineno}`, 'error');
            });
            
            updateStatus('console', true, 'âœ… Monitor de console ativo');
            addLog('âœ… Monitor de console ativo - todas as mensagens serÃ£o capturadas', 'success');
        }

        // SimulaÃ§Ã£o do Dashboard
        async function simulateDashboard() {
            addLog('ğŸ® Iniciando simulaÃ§Ã£o completa do dashboard...', 'info');
            
            try {
                // Passo 1: Simular loadUserData()
                addLog('Passo 1: Simulando loadUserData()...', 'info');
                
                const [userResponse, guildsResponse] = await Promise.all([
                    fetch('/api/user'),
                    fetch('/api/guilds')
                ]);
                
                const userData = await userResponse.json();
                const guildsData = await guildsResponse.json();
                
                addLog(`User response: ${JSON.stringify(userData)}`, 'info');
                addLog(`Guilds response: ${JSON.stringify(guildsData)}`, 'info');
                
                if (userData.success && guildsData.success) {
                    addLog('âœ… Dados do usuÃ¡rio e guilds carregados', 'success');
                    
                    // Passo 2: Simular seleÃ§Ã£o de servidor
                    if (guildsData.guilds && guildsData.guilds.length > 0) {
                        const firstGuild = guildsData.guilds[0];
                        addLog(`Passo 2: Simulando seleÃ§Ã£o do servidor ${firstGuild.name}...`, 'info');
                        
                        // Passo 3: Simular loadServerData()
                        addLog('Passo 3: Simulando loadServerData()...', 'info');
                        
                        const statsResponse = await fetch(`/api/server/${firstGuild.id}/stats`);
                        const statsData = await statsResponse.json();
                        
                        addLog(`Stats response: ${JSON.stringify(statsData)}`, 'info');
                        
                        if (statsData.success) {
                            addLog('âœ… EstatÃ­sticas do servidor carregadas', 'success');
                            updateStatus('sim', true, 'âœ… SimulaÃ§Ã£o completa bem-sucedida!');
                        } else {
                            addLog('âŒ Falha ao carregar estatÃ­sticas', 'error');
                            updateStatus('sim', false, 'âŒ Falha nas estatÃ­sticas do servidor');
                        }
                    } else {
                        addLog('âš ï¸ Nenhum servidor disponÃ­vel', 'warning');
                        updateStatus('sim', false, 'âš ï¸ Nenhum servidor encontrado');
                    }
                } else {
                    addLog('âŒ Falha ao carregar dados iniciais', 'error');
                    updateStatus('sim', false, 'âŒ Falha nos dados iniciais');
                }
                
            } catch (error) {
                addLog(`âŒ Erro na simulaÃ§Ã£o: ${error.message}`, 'error');
                updateStatus('sim', false, `âŒ Erro: ${error.message}`);
            }
        }

        // InicializaÃ§Ã£o
        window.addEventListener('load', function() {
            addLog('ğŸš€ PÃ¡gina de diagnÃ³stico carregada', 'success');
            addLog('ğŸ‘† Clique nos botÃµes acima para testar componentes especÃ­ficos', 'info');
            addLog('ğŸ’¡ O "Monitorar Console" captura todos os erros JavaScript', 'info');
        });
    </script>
        <script src="/js/toast-fallback.js"></script>
        <script src="/js/event-fallback.js"></script>
    </body>
    </html>
