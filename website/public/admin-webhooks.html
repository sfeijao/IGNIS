<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Webhooks Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- admin-webhooks styles moved to css/style.css (.admin-webhooks) -->
  </head>
<body class="admin-webhooks">
  <script src="/js/frontend-helpers.js"></script>
  <script src="/js/dompurify.min.js"></script>
  <h2>Webhooks</h2>
  <p>Configure the archive webhook for ticket archiving and test delivery.</p>

  <div class="form-row">
    <label for="guildId">Guild ID</label>
    <input id="guildId" value="1333820000791691284" aria-label="Guild ID" />
  </div>

  <div class="form-row">
    <label for="archive">Archive Webhook URL</label>
    <input id="archive" placeholder="https://discord.com/api/webhooks/..." aria-label="Archive Webhook URL" />
  </div>

  <div class="form-actions">
    <button id="load" type="button">Load</button>
    <button id="save" type="button">Save</button>
    <button id="testWebhook" type="button">Test Webhook</button>
  </div>

  <div id="status" aria-live="polite" role="status"></div>

  <script>
    async function api(path, method='GET', body=null) {
      const gidEl = document.getElementById('guildId');
      const guildId = gidEl ? String(gidEl.value || '').trim() : '';
      const safeGuildId = encodeURIComponent(guildId);
      const url = '/api' + (path.indexOf(':guildId') !== -1 ? path.replace(':guildId', safeGuildId) : path);
      const opts = { method, headers: {} };
      if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
      try {
        const res = await fetch(url, opts);
        try { return await res.json(); } catch (e) { return { success: false, error: 'Invalid JSON response', status: res.status }; }
      } catch (e) {
        return { success: false, error: (e && e.message) ? e.message : String(e) };
      }
    }

    (function(){
      const loadBtn = document.getElementById('load');
      if (!loadBtn) return;
      loadBtn.addEventListener('click', async ()=>{
        safeSetStatus('Loading...');
        setButtonsDisabled(true);
        try{
          const j = await api('/config/archive-webhook');
          if (j && j.success) {
            const archiveEl = document.getElementById('archive'); if (archiveEl) archiveEl.value = j.webhookUrl || '';
            safeSetStatus('Loaded');
          } else safeSetStatus(j && j.error ? String(j.error) : JSON.stringify(j, null, 2));
        } catch (e) { safeSetStatus((e && e.message) ? e.message : JSON.stringify(e)); }
        setButtonsDisabled(false);
      });
    })();

    (function(){
      const saveBtn = document.getElementById('save');
      if (!saveBtn) return;
      saveBtn.addEventListener('click', async ()=>{
        safeSetStatus('Saving...');
        setButtonsDisabled(true);
        try{
          const archiveEl = document.getElementById('archive');
          const webhookUrl = archiveEl ? (archiveEl.value || null) : null;
          const ok = !webhookUrl || /^https:\/\/discord(?:app)?\.com\/api\/webhooks\/.+/.test(webhookUrl);
          if (!ok) { safeSetStatus('Webhook URL inválida'); setButtonsDisabled(false); return; }
          const j = await api('/config/archive-webhook', 'POST', { webhookUrl });
          // If server returns webhookUrl, avoid echoing it fully in the UI
          if (j && j.success && j.webhookUrl) {
            const masked = j.webhookUrl.replace(/(https:\/\/discord(?:app)?\.com\/api\/webhooks\/[^\/]+\/)[^\/]+$/, '$1••••');
            safeSetStatus('Saved — webhook: ' + masked);
          } else {
            safeSetStatus(j && j.error ? String(j.error) : JSON.stringify(j, null, 2));
          }
        } catch(e){ safeSetStatus((e && e.message) ? e.message : JSON.stringify(e)); }
        setButtonsDisabled(false);
      });
    })();

    (function(){
      const testBtn = document.getElementById('testWebhook');
      if (!testBtn) return;
      testBtn.addEventListener('click', async ()=>{
        safeSetStatus('Testing webhook...');
        setButtonsDisabled(true);
        try{
          const res = await api('/config/archive-webhook/test', 'POST');
          safeSetStatus(res && res.success ? 'Test sent' : (res && res.error ? String(res.error) : JSON.stringify(res, null, 2)));
        }catch(e){ safeSetStatus((e && e.message) ? e.message : JSON.stringify(e)); }
        setButtonsDisabled(false);
      });
    })();

    // Helper: safe status updater (uses textContent, optionally DOMPurify if HTML allowed later)
    function safeSetStatus(value){
      const st = document.getElementById('status');
      if (!st) return;
      // If value looks like JSON or plain text, write as textContent to avoid innerHTML risks
      if (typeof value === 'string') {
        st.textContent = value;
        return;
      }
      try {
        st.textContent = JSON.stringify(value, null, 2);
      } catch(e) {
        st.textContent = String(value);
      }
    }

    function setButtonsDisabled(state){
      ['load','save','testWebhook'].forEach(id=>{ const b=document.getElementById(id); if(b) b.disabled = !!state; });
    }
  </script>
</body>
</html>
