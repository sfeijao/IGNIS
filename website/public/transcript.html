<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Transcript</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container" style="padding:1rem;">
    <h2 id="title">Transcript</h2>
    <div id="messages">Loading...</div>
  </div>

  <script src="/js/frontend-helpers.js"></script>
  <script src="/js/dompurify.min.js"></script>
  <script>
    (function(){
      function getTicketIdFromPath(){
        // path: /transcript/:ticketId
        const parts = location.pathname.split('/').filter(Boolean);
        return parts.length >= 2 ? parts[1] : null;
      }

      async function load(){
        const ticketId = getTicketIdFromPath();
        if(!ticketId){
          document.getElementById('messages').textContent = 'Ticket ID invÃ¡lido';
          return;
        }
        document.getElementById('title').textContent = 'Transcript #' + ticketId;
        try{
          const r = await fetch('/api/transcript/' + encodeURIComponent(ticketId) + '/data');
          if(!r.ok){ document.getElementById('messages').textContent = 'Falha ao carregar transcript'; return; }
          const data = await r.json();
          const box = document.getElementById('messages');
          box.textContent = '';
          if(!data.messages || data.messages.length === 0){ box.textContent = 'No messages found.'; return; }

          data.messages.forEach(m => {
            const el = document.createElement('div'); el.className = 'msg'; el.style.borderBottom = '1px solid #ddd'; el.style.padding = '.5rem 0';
            const userDiv = document.createElement('div'); userDiv.className = 'user'; userDiv.textContent = String(m.username || m.user_id || 'Unknown');
            const timeSpan = document.createElement('span'); timeSpan.style.fontWeight = '400'; timeSpan.style.color = '#666'; timeSpan.textContent = ' ' + (m.created_at ? new Date(m.created_at).toLocaleString() : '');
            userDiv.appendChild(timeSpan);
            el.appendChild(userDiv);

            const contentDiv = document.createElement('div'); contentDiv.className = 'content';
            if(m.message){
              // Break into lines and append safe text nodes
              const parts = String(m.message).split(/\n/);
              parts.forEach((p, i) => {
                // Remove unresolved template placeholders if present
                const clean = p.replace(/\$\{[^}]*\}/g, '').replace(/%24%7B/gi, '');
                contentDiv.appendChild(document.createTextNode(clean));
                if(i < parts.length - 1) contentDiv.appendChild(document.createElement('br'));
              });
            }
            el.appendChild(contentDiv);
            box.appendChild(el);
          });
        }catch(e){
          document.getElementById('messages').textContent = 'Erro ao carregar transcript';
          console.debug('transcript load error', e);
        }
      }

      // Run on load
      document.addEventListener('DOMContentLoaded', load);
    })();
  </script>
</body>
</html>
