<!doctype html>
<html>
  <head>
  <meta charset="utf-8">
  <title>Guild Config Admin</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- admin-guild-config small styles moved to css/style.css (.admin-small/.admin-webhooks) -->
</head>
<body class="admin-small">
  <!-- helpers loaded at end of body -->
  <h2>Guild Config Admin</h2>
  <p>Access via <em>localhost</em> or provide a Bearer token in DevTools network headers.</p>

  <label>Guild ID <input id="guildId" value="1333820000791691284"></label>

  <div class="mb-1">
    <a href="/admin-webhooks.html">Configurar Webhooks (mover)</a>
  </div>
  <label>Log Channel ID <input id="logChannel" placeholder="channel id" /></label>
  <label>Ticket Category ID <input id="ticketCategory" placeholder="category id" /></label>
  <label>Staff Role ID <input id="staffRole" placeholder="staff role id" /></label>
  <label>Verify Role ID <input id="verifyRole" placeholder="verify role id" /></label>
  <small id="validateMsg"></small>

  <button id="load">Load</button>
  <button id="save">Save</button>
  <!-- Webhook management moved to /admin-webhooks.html -->

  <div id="sessionInfo"></div>

  <pre id="status"></pre>

  <div id="adminLogs">
    <h3>Recent Admin Logs</h3>
    <div>
      <button id="refreshLogs">Refresh Logs</button>
      <button id="prevPage">Previous</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextPage">Next</button>
    </div>
    <ul id="logList"></ul>
  </div>

  <script>
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function api(path, method='GET', body=null) {
      const guildId = document.getElementById('guildId').value;
  const url = '/api' + path.replace(':guildId', encodeURIComponent(guildId));
      const opts = { method, headers: {} };
      if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
      const res = await fetch(url, opts);
      return res.json();
    }

    // Auto-fill guildId from query string if present
    const qGuild = getQueryParam('guildId');
    if (qGuild) document.getElementById('guildId').value = qGuild;

    // If guildId present in query, set it into the session so server-side APIs can use req.session.guild
    async function ensureSessionGuild(guildId) {
      try {
        await fetch('/api/session/server', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ guildId }) });
      } catch (e) {
        // Ignore session set failures in dev
        console.warn('Failed to set session guild', e && e.message ? e.message : e);
      }
    }

    if (qGuild) ensureSessionGuild(qGuild);

    document.getElementById('load').addEventListener('click', async () => {
      const status = document.getElementById('status'); status.textContent = 'Loading...';
      try {
        const data = await api('/admin/guild-config/:guildId');
        if (data.success) {
          document.getElementById('logChannel').value = data.config.log_channel_id || '';
          document.getElementById('ticketCategory').value = data.config.ticket_category_id || '';
          document.getElementById('staffRole').value = data.config.staff_role_id || '';
          document.getElementById('verifyRole').value = data.config.verify_role_id || '';
          // Show session guild info if available
          try{
            const s = await fetch('/api/session/server'); const sj = await s.json(); if (sj.guild) document.getElementById('sessionInfo').textContent = 'Session guild: ' + sj.guild.name + ' (' + sj.guild.id + ')';
          }catch(e){}
          status.textContent = 'Loaded';
        } else {
          status.textContent = JSON.stringify(data);
        }
      } catch (e) { status.textContent = e.message }
    });

    document.getElementById('save').addEventListener('click', async () => {
      const status = document.getElementById('status'); status.textContent = 'Saving...';
      const validateMsg = document.getElementById('validateMsg'); validateMsg.textContent = '';
      try {
        const body = {
          log_channel_id: document.getElementById('logChannel').value || null,
          ticket_category_id: document.getElementById('ticketCategory').value || null,
          staff_role_id: document.getElementById('staffRole').value || null,
          verify_role_id: document.getElementById('verifyRole').value || null
        };
        const data = await api('/admin/guild-config/:guildId', 'POST', body);
        status.textContent = JSON.stringify(data, null, 2);
      } catch (e) { status.textContent = e.message }
    });

  // Webhook testing/mgmt moved to the dedicated Webhooks admin page (/admin-webhooks.html)

    let currentPage = 1;
    const pageInfo = document.getElementById('pageInfo');

    async function loadLogs(page = 1) {
      const ul = document.getElementById('logList'); if (ul) { while(ul.firstChild) ul.removeChild(ul.firstChild); const liLoad = document.createElement('li'); liLoad.textContent = 'Loading...'; ul.appendChild(liLoad);} 
      try{
        const limit = 10;
  const j = await api('/admin/logs?limit=' + encodeURIComponent(limit) + '&page=' + encodeURIComponent(page));
  while(ul.firstChild) ul.removeChild(ul.firstChild);
        if (j.logs && j.logs.length) {
          j.logs.forEach(l=>{ const li = document.createElement('li'); li.textContent = String(l.timestamp) + ' [' + String(l.type) + '] ' + String(l.message); ul.appendChild(li); });
        } else ul.textContent = 'No logs';

        currentPage = (j.pagination && j.pagination.page) || page;
        const pages = (j.pagination && j.pagination.pages) || 1;
  pageInfo.textContent = 'Page ' + currentPage + ' / ' + pages;
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= pages;
      }catch(e){ ul.textContent = e && e.message ? e.message : JSON.stringify(e) }
    }

    document.getElementById('refreshLogs').addEventListener('click', ()=> loadLogs(currentPage));
    document.getElementById('prevPage').addEventListener('click', ()=> { if (currentPage>1) loadLogs(currentPage-1); });
    document.getElementById('nextPage').addEventListener('click', ()=> { loadLogs(currentPage+1); });

    // initial load
      loadLogs(1);
    </script>
    <!-- Include DOMPurify then frontend helpers once at end of body -->
    <script src="/js/dompurify.min.js"></script>
    <script src="/js/frontend-helpers.js"></script>
  </body>
  </html>
