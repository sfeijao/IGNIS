<!DOCTYPE html>
<html>
<head>
    <title>YSNM - Status de AutenticaÃ§Ã£o</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- auth-status styles moved to css/style.css (.auth-status) -->
</head>
<body>
    <!-- helpers will be loaded at end of body -->
    <h2>ğŸ” YSNM - Status de AutenticaÃ§Ã£o</h2>
    
    <div id="cookieStatus" class="status auth-status">
        <h3>ğŸª Cookie Status</h3>
        <p id="cookieInfo">Verificando...</p>
    </div>
    
    <div id="localStorageStatus" class="status">
        <h3>ğŸ’¾ LocalStorage Status</h3>
        <p id="localStorageInfo">Verificando...</p>
    </div>
    
    <div id="apiStatus" class="status">
        <h3>ğŸŒ API Status</h3>
        <p id="apiInfo">Verificando...</p>
    </div>
    
    <div>
        <button onclick="testAPI()">ğŸ§ª Test API</button>
        <button onclick="clearAuth()">ğŸ—‘ï¸ Clear Auth</button>
        <button onclick="goToLogin()">ğŸ”‘ Go to Login</button>
        <button onclick="goToMain()">ğŸ  Go to Main</button>
    </div>
    
    <script>
        function getCookie(name) {
            const value = '; ' + document.cookie;
            const parts = value.split('; ' + name + '=');
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        function checkStatus() {
            // Check cookies
            const cookieToken = getCookie('authToken');
            const cookieInfo = document.getElementById('cookieInfo');
            const cookieStatus = document.getElementById('cookieStatus');
            
            if (cookieToken) {
                // Do not reveal token contents in the UI
                cookieInfo.textContent = 'Token encontrado (oculto)';
                cookieStatus.className = 'status success';
            } else {
                cookieInfo.textContent = 'Nenhum token encontrado nos cookies';
                cookieStatus.className = 'status error';
            }
            
            // Check localStorage
            const localToken = localStorage.getItem('authToken');
            const localInfo = document.getElementById('localStorageInfo');
            const localStatus = document.getElementById('localStorageStatus');
            
            if (localToken) {
                // Do not reveal token contents in the UI
                localInfo.textContent = 'Token encontrado (oculto)';
                localStatus.className = 'status success';
            } else {
                localInfo.textContent = 'Nenhum token encontrado no localStorage';
                localStatus.className = 'status error';
            }
        }
        
        async function testAPI() {
            const apiInfo = document.getElementById('apiInfo');
            const apiStatus = document.getElementById('apiStatus');
            
            try {
                apiInfo.textContent = 'Testando API...';
                
                const response = await fetch('/api/channels', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    apiInfo.textContent = 'API funcionando! ' + (data.length || 0) + ' canais encontrados';
                    apiStatus.className = 'status success';
                } else {
                    apiInfo.textContent = 'Erro API: ' + response.status + ' - ' + response.statusText;
                    apiStatus.className = 'status error';
                }
            } catch (error) {
                apiInfo.textContent = 'Erro: ' + (error && error.message ? error.message : String(error));
                apiStatus.className = 'status error';
            }
        }
        
        function clearAuth() {
            // Clear cookies
            document.cookie = 'authToken=; Max-Age=0; Path=/';
            // Clear localStorage
            localStorage.removeItem('authToken');
            alert('AutenticaÃ§Ã£o limpa!');
            checkStatus();
        }
        
        function goToLogin() {
            (function(){ try{ if (window.location.pathname !== '/login' && !sessionStorage.getItem('redirectingToLogin')){ sessionStorage.setItem('redirectingToLogin','1'); setTimeout(()=>sessionStorage.removeItem('redirectingToLogin'),10000); window.location.replace('/login'); } }catch(e){ try{ window.location.href='/login'; }catch(_){} }})();
        }
        
        function goToMain() {
            window.location.href = '/';
        }
        
        // Check status on load
        checkStatus();
        testAPI();
    </script>
        <script src="/js/toast-fallback.js"></script>
        <!-- Ensure DOMPurify then frontend helpers are loaded last -->
        <script src="/js/dompurify.min.js"></script>
        <script src="/js/frontend-helpers.js"></script>
    </body>
    </html>
