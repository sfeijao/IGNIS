<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Admin Roles</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- admin small roles styles moved to css/style.css (.admin-small) -->
</head>
<body>
  <!-- helpers loaded at end of body -->
  <h2>Roles</h2>
  <div>
    <label>Server ID <input id="guildId" placeholder="guild id" /></label>
    <button id="setSession">Set Session</button>
  </div>

  <h3>Existing Roles</h3>
  <button id="refresh">Refresh List</button>
  <ul id="list"></ul>

  <h3>Create Role</h3>
  <label>Name <input id="name" /></label>
  <label>Color (hex) <input id="color" placeholder="#AABBCC" /></label>
  <label>Hoist <select id="hoist"><option value="false">No</option><option value="true">Yes</option></select></label>
  <label>Mentionable <select id="mention"><option value="false">No</option><option value="true">Yes</option></select></label>
  <button id="create">Create</button>

  <pre id="out" class="pre-out"></pre>

  <script>
    async function api(path, method='GET', body=null) {
      const guildId = document.getElementById('guildId').value || (await getSessionGuild())?.id;
      if (!guildId) throw new Error('Guild ID not set');
      const url = path.replace(':serverId', guildId).replace(':guildId', guildId);
      const opts = { method, headers: {} };
      if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
      const res = await fetch(url, opts);
      return res.json();
    }

    async function getSessionGuild(){
      try{ const r = await fetch('/api/session/server'); const j = await r.json(); return j.guild || null; }catch(e){return null}
    }

    document.getElementById('setSession').addEventListener('click', async ()=>{
      const gid = document.getElementById('guildId').value;
      if (!gid) return alert('Enter guild id');
      await fetch('/api/session/server', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ guildId: gid }) });
      document.getElementById('out').textContent = 'Session set to ' + gid;
    });

    document.getElementById('refresh').addEventListener('click', load);

    async function load(){
      const out = document.getElementById('out'); out.textContent = 'Loading...';
      try{
        const guild = await getSessionGuild(); if (guild) document.getElementById('guildId').value = guild.id;
        const data = await api('/api/server/:serverId/roles');
  const ul = document.getElementById('list'); if (ul) { while (ul.firstChild) ul.removeChild(ul.firstChild); }
        if (data.roles && data.roles.length){
          data.roles.forEach(r=>{ 
            const li = document.createElement('li'); 
            li.textContent = r.name + ' (' + r.id + ') - members: ' + r.memberCount;
            const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.style.marginLeft='8px';
            editBtn.addEventListener('click', async ()=>{
              const newName = prompt('New role name', r.name);
              if (newName === null) return;
              const color = prompt('Hex color (e.g. #AABBCC) or leave blank', r.color || '');
              const hoist = confirm('Hoist role (display separately)?');
              const mention = confirm('Mentionable?');
              const body = { name: newName }; if (color) body.color = color; body.hoist = hoist; body.mentionable = mention;
              const res = await fetch('/api/admin/roles/' + r.id, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); const j = await res.json();
              document.getElementById('out').textContent = JSON.stringify(j, null, 2);
              if (j.success) load();
            });
            const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.style.marginLeft='4px';
            delBtn.addEventListener('click', async ()=>{
              const ok = prompt('Type DELETE to confirm deletion, or type FORCE to force delete role even if members exist');
              if (!ok) return;
              if (ok !== 'DELETE' && ok !== 'FORCE') return alert('Cancelled');
              const body = ok === 'FORCE' ? JSON.stringify({ force: true }) : null;
              const rres = await fetch('/api/admin/roles/' + r.id, { method: 'DELETE', headers: body ? {'Content-Type':'application/json'} : {}, body }); const j = await rres.json();
              document.getElementById('out').textContent = JSON.stringify(j, null, 2);
              if (j.success) load();
            });
            li.appendChild(editBtn); li.appendChild(delBtn);
            ul.appendChild(li);
          });
        } else ul.textContent = 'No roles';
        out.textContent = 'Loaded ' + (data.roles ? data.roles.length : 0) + ' roles';
      }catch(e){ out.textContent = e && e.message ? e.message : JSON.stringify(e); }
    }

    document.getElementById('create').addEventListener('click', async ()=>{
      const name = document.getElementById('name').value; const color = document.getElementById('color').value || null; const hoist = document.getElementById('hoist').value === 'true'; const mention = document.getElementById('mention').value === 'true';
      const out = document.getElementById('out'); out.textContent = 'Creating...';
      try{
        const res = await api('/api/admin/roles', 'POST', { name, color, hoist, mention });
        out.textContent = JSON.stringify(res, null, 2);
        if (res.success) load();
      }catch(e){ out.textContent = e && e.message ? e.message : JSON.stringify(e); }
    });

    (async ()=>{ const g = await getSessionGuild(); if (g) document.getElementById('guildId').value = g.id; await load(); })();
  </script>
  <!-- Include DOMPurify then frontend helpers once at end of body -->
  <script src="/js/dompurify.min.js"></script>
  <script src="/js/frontend-helpers.js"></script>
</body>
</html>
