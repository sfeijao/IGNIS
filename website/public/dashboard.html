<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; script-src-attr 'none'; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src 'self' cdn.jsdelivr.net fonts.gstatic.com; img-src 'self' data: cdn.discordapp.com; connect-src 'self';">
    <title>YSNM Bot - Modern Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn.discordapp.com/icons/1333825066928214053/a_8c5e2b5b5f4d3c2a1e0f9b8d7c6e5a4b.gif" type="image/gif">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
</head>
<body>
    <!-- page content scripts will be loaded at end of body to ensure DOM is available -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <img src="https://cdn.discordapp.com/icons/1333825066928214053/a_8c5e2b5b5f4d3c2a1e0f9b8d7c6e5a4b.gif" alt="YSNM Logo" class="logo">
                <div class="header-text">
                    <h1><i class="fas fa-rocket"></i> YSNM Modern Dashboard</h1>
                    <p>Sistema avançado de gestão para Discord bot</p>
                </div>
                <div class="header-actions">
                    <button id="configBtn" class="config-btn" title="Configurar Token">
                        <i class="fas fa-cog"></i>
                        <span>Config</span>
                    </button>
                    <button id="logoutBtn" class="logout-btn" title="Terminar sessão">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
                <!-- Inlined dashboard JavaScript removed: functionality moved to /js/script.js to avoid accidental rendering as text -->
    <script>
        // UI and runtime fixes (sanitization + debug wrapper)
        (function(){
            // Simple debug flag persisted in localStorage (user toggle available)
            function isDebug() { return localStorage.getItem('YSNM_DEBUG') === '1'; }
            function setDebug(v) { localStorage.setItem('YSNM_DEBUG', v ? '1' : '0'); }

            // Wrap console.* so it only logs when debug is enabled
            const _console = { log: console.log.bind(console), warn: console.warn.bind(console), error: console.error.bind(console), info: console.info.bind(console) };
            ['log','warn','error','info'].forEach(fn => {
                console[fn] = function(...args){ if (isDebug()) _console[fn](...args); };
            });

            // Replace any visible template placeholders like $ + '{' + '...}' in text nodes and attributes
            window.sanitizeTemplatePlaceholders = function(){
                const placeholderRegex = /\$\{[^}]+\}/g;

                // Fix attributes (src, href, data-*)
                document.querySelectorAll('[src],[href],[data-src]').forEach(el => {
                    ['src','href','data-src'].forEach(attr => {
                        if (!el.hasAttribute(attr)) return;
                        const val = el.getAttribute(attr);
                        if (!val) return;
                        // encoded forms sometimes appear (e.g. %24%7B)
                        if (val.includes('$' + '{') || val.includes('%24%7B')) {
                            // If it's an image, set a safe default
                            if (el.tagName.toLowerCase() === 'img') {
                                el.setAttribute('src','/default-avatar.png');
                                el.removeAttribute('srcset');
                            } else {
                                el.removeAttribute(attr);
                            }
                        }
                    });
                });

                // Clean text nodes containing placeholders
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
                const toChange = [];
                while(walker.nextNode()){
                    const node = walker.currentNode;
                    if (node.nodeValue && placeholderRegex.test(node.nodeValue)) {
                        toChange.push(node);
                    }
                }
                toChange.forEach(n => n.nodeValue = n.nodeValue.replace(placeholderRegex, ''));
            };

            // Attach robust fallback handler to images
            window.attachImageFallbacks = function(){
                const defaultSrc = '/default-avatar.png';
                document.querySelectorAll('img').forEach(img => {
                    // If src looks like an unprocessed template, fix it now
                    const src = img.getAttribute('src') || '';
                    if (src.includes('$' + '{') || src.includes('%24%7B')) {
                        img.src = defaultSrc;
                    }

                    // Avoid infinite loops
                    img.addEventListener('error', function onErr(){
                        try { img.removeEventListener('error', onErr); } catch(e){}
                        // Replace with inline SVG fallback for crispness
                        img.src = defaultSrc;
                        img.style.objectFit = 'cover';
                    });
                });
            };

            // Small floating control for toggling debug mode and running sanitizers
            function createDebuggerWidget(){
                if (document.getElementById('ysnm-debug-widget')) return;
                const w = document.createElement('div');
                w.id = 'ysnm-debug-widget';
                w.style.cssText = 'position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.6);color:#fff;padding:8px;border-radius:8px;font-size:12px;z-index:10001;backdrop-filter:blur(4px);';
                const inner = document.createElement('div'); inner.className = 'flex-row';
                const toggleBtn = document.createElement('button'); toggleBtn.id = 'ysnm-debug-toggle'; toggleBtn.title = 'Toggle debug'; toggleBtn.style.cssText = 'background:#111;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer;'; toggleBtn.textContent = isDebug() ? 'DEBUG ON' : 'debug';
                const fixBtn = document.createElement('button'); fixBtn.id = 'ysnm-sanitize-btn'; fixBtn.title = 'Fix placeholders'; fixBtn.style.cssText = 'background:#0b78d1;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer;'; fixBtn.textContent = 'Fix';
                inner.appendChild(toggleBtn); inner.appendChild(fixBtn);
                w.appendChild(inner);
                document.body.appendChild(w);
                toggleBtn.addEventListener('click', ()=>{
                    setDebug(!isDebug());
                    toggleBtn.textContent = isDebug() ? 'DEBUG ON' : 'debug';
                    // Confirm reload to avoid accidental refresh loops
                    if (confirm('Reload page to apply debug state?')) {
                        try { window.location.reload(); } catch(e) { /* noop */ }
                    }
                });
                fixBtn.addEventListener('click', ()=>{ sanitizeTemplatePlaceholders(); attachImageFallbacks(); alert('Sanitização aplicada'); });
            }

            // Run on load (non-blocking)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => { createDebuggerWidget(); });
            } else {
                createDebuggerWidget();
            }
        })();

    </script>

    <script>
        // Production authentication helper functions
        function promptForToken() {
            const token = prompt('Insira o token de acesso para Railway:');
            if (token && token.trim()) {
                if (!confirm('Guardar este token no armazenamento local? Isto é inseguro em ambientes partilhados.')) return;
                localStorage.setItem('productionToken', token.trim());
                // Do not set authToken automatically; require explicit user action or reload
                alert('Token armazenado como productionToken. Use a opção de sessão para ativar.');
            }
        }
        
        function redirectToOAuth() {
            // Redirect to Discord OAuth
            window.location.href = '/auth/discord';
        }
        
        // Add token input to production interface
        if (window.location.hostname.includes('railway.app')) {
            document.addEventListener('DOMContentLoaded', function() {
                // Add production token input to top nav
                const navbar = document.querySelector('.navbar');
                if (navbar) {
                    const tokenInput = document.createElement('div'); tokenInput.className = 'ml-auto mr-3';
                    const prodInput = document.createElement('input'); prodInput.type = 'password'; prodInput.id = 'prodToken'; prodInput.placeholder = 'Token de Acesso'; prodInput.className = 'form-control form-control-sm'; prodInput.style.cssText = 'width:200px;display:inline-block;';
                    const setBtn = document.createElement('button'); setBtn.className = 'btn btn-primary btn-sm ml-2'; setBtn.textContent = 'Definir'; setBtn.addEventListener('click', setProductionToken);
                    tokenInput.appendChild(prodInput); tokenInput.appendChild(setBtn); navbar.appendChild(tokenInput);
                }
            });
        }
        
        function setProductionToken() {
            const tokenInput = document.getElementById('prodToken');
            const token = tokenInput?.value?.trim();
            if (token) {
                if (!confirm('Guardar este token no armazenamento local? Isto é inseguro em ambientes partilhados.')) return;
                localStorage.setItem('productionToken', token);
                // Do not auto-set authToken; admin should enable session explicitly
                tokenInput.value = '';
                alert('Token guardado como productionToken. Por favor ative sessão manualmente se necessário.');
            }
        }
    </script>
    <script src="/js/toast-fallback.js"></script>
    <script src="/js/event-fallback.js"></script>
    <!-- Include DOMPurify then frontend helpers once at end of body -->
    <script src="/js/dompurify.min.js"></script>
    <script src="/js/frontend-helpers.js"></script>
    <script src="/js/script.js"></script>
</body>
</html>
