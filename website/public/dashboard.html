<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; script-src-attr 'none'; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src 'self' cdn.jsdelivr.net fonts.gstatic.com; img-src 'self' data: cdn.discordapp.com; connect-src 'self';">
    <title>YSNM Bot - Modern Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn.discordapp.com/icons/1333825066928214053/a_8c5e2b5b5f4d3c2a1e0f9b8d7c6e5a4b.gif" type="image/gif">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
</head>
<body>
    <!-- page content scripts will be loaded at end of body to ensure DOM is available -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <img src="https://cdn.discordapp.com/icons/1333825066928214053/a_8c5e2b5b5f4d3c2a1e0f9b8d7c6e5a4b.gif" alt="YSNM Logo" class="logo">
                <div class="header-text">
                    <h1><i class="fas fa-rocket"></i> YSNM Modern Dashboard</h1>
                    <p>Sistema avançado de gestão para Discord bot</p>
                </div>
                <div class="header-actions">
            <!-- Ticket functions moved into /js/script.js to avoid duplication and visible JS text -->
            <!-- (ticket DOM creation handled in /js/script.js::YSNMDashboard.updateTicketsDisplay) -->

                
        // legacy hook replaced by global in /js/script.js
            
        updateTokenDisplay() {
                // Update token displays across the page
                try {


                } catch(e){}
            }

            async loadWebhookConfig() {
                try {

                            headers: {
                                'Authorization': 'Bearer ' + (getAuthToken() || '')
                            }
                        });

                    if (response.ok) {


                        if (webhookInput && data.webhookUrl) {
                            webhookInput.value = data.webhookUrl;
                        }
                    } else {

                    }
                } catch (error) {

                }
            }

            async saveWebhookConfig() {


                
                if (!webhookInput || !statusDiv) return;


                
                // Validar URL do webhook
                if (webhookUrl && !webhookUrl.includes('discord.com/api/webhooks/')) {
                    this.showWebhookStatus('URL do webhook deve ser do Discord (discord.com/api/webhooks/...)', 'error');
                    return;
                }

                try {
                    this.showWebhookStatus('A guardar configuração...', 'loading');


                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (getAuthToken() || '')
                            <!-- Ticket functions moved into /js/script.js to avoid duplication and visible JS text -->
                            <!-- Webhook and token helpers live in /js/script.js as class methods -->
*** End Patch
                return;
            }
            
            // Map action title to API action

            switch(actionTitle) {
                case 'Avisar Utilizador':
                    action = 'warn';
                    break;
                case 'Silenciar Utilizador':
                    action = 'timeout';
                    break;
                case 'Timeout':
                    action = 'timeout';
                    break;
                case 'Expulsar Utilizador':
                    action = 'kick';
                    break;
                case 'Banir Utilizador':
                    action = 'ban';
                    break;
                default:
                    action = 'warn';
            }
            
            // Show loading state


            executeBtn.textContent = 'Executando...';
            executeBtn.disabled = true;
            
            // Prepare request data

                action: action,
                memberId: user,
                reason: reason || 'Sem motivo especificado'
            };
            
            // Add duration for timeout actions
            if ((action === 'timeout' || action === 'mute') && duration) {
                requestData.duration = parseInt(duration) * 1000; // Convert to milliseconds
            }
            
            // Execute moderation action via API
                fetch('/api/admin/members/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (getAuthToken() || '')
                },
                body: JSON.stringify(requestData)
            })
            .then(async response => {

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + (data.error || 'Erro no servidor'));
                }
                return data;
            })
            .then(data => {
                if (data.success) {

                    if (data.note) message += '⚠️ ' + data.note + '\n';
                    message += 'Utilizador: ' + user + '\nMotivo: ' + (requestData.reason || '');
                    alert(message);
                    hideModerationAction();
                    
                    // Clear form




                    }
                    
                    // Add to recent activity or refresh logs
                    addModerationLog(action, user, requestData.reason);
                } else {
                    alert('❌ Erro: ' + (data.error || 'Falha ao executar ação'));
                }
            })
            .catch(error => {

                

                if (error.message.includes('403')) {
                    errorMessage = '❌ Erro: Permissões insuficientes. Verifique se está logado.';
                } else if (error.message.includes('404')) {
                    errorMessage = '❌ Erro: Membro não encontrado no servidor.';
                } else if (error.message.includes('500')) {
                    errorMessage = '❌ Erro interno do servidor. O bot pode estar offline.';
                } else if (error.message.includes('400')) {
                    errorMessage = '❌ Erro: Dados inválidos fornecidos.';
                }
                
                alert(errorMessage + '\n\nDetalhes técnicos: ' + (error.message || ''));
                addModerationLog('error', user, 'Falha na ação: ' + (error.message || ''));
            })
            .finally(() => {
                // Reset button state
                executeBtn.textContent = originalText;
                executeBtn.disabled = false;
            });
        }
        
        function getAuthToken() {
            // Try to get token from cookie first

                .split('; ')
                .find(row => row.startsWith('authToken='))
                ?.split('=')[1];
                
            if (cookieToken) {
                return cookieToken;
            }
            
            // Try localStorage

            if (localToken) {
                return localToken;
            }
            
            // For local development, do NOT auto-insert a dev token; require explicit user action
            if (window.location.protocol === 'file:' || 
                window.location.hostname === 'localhost' || 
                window.location.hostname === '127.0.0.1') {
                return null; // no auto-token
            }

            // For Railway production, do NOT auto-store tokens from URL; require explicit configuration
            if (window.location.hostname.includes('railway.app')) {
                // If there's a token param, show presence only and do not persist it automatically


                if (prodToken) {
                    // do not call localStorage.setItem here; return marker for presence
                    return '***present***';
                }
                // Do not return admin-token by default; prefer explicit OAuth flow
                return null;
            }
            
            // Fallback empty token (backend will handle local dev)
            return '';
        }
        


            if (container) {


                    'warn': 'Aviso',
                    'timeout': 'Timeout',
                    'kick': 'Expulsão',
                    'ban': 'Banimento',
                    'error': 'Erro'
                };
                


                

                newLog.className = logClass;

                time.className = 'log-time';
                time.textContent = '[' + currentTime + ']';

                msg.className = 'log-message';
                msg.textContent = icon + ' ' + (actionNames[action] || action) + ' - ' + user + ': ' + reason;


                container.insertBefore(newLog, container.firstChild);
                
                // Limit to 50 logs
                while (container.children.length > 50) {
                    container.removeChild(container.lastChild);
                }
            }
        }

        // Embed functions
        function updateEmbedPreview() {




            

            // Clear previous preview
            while (preview.firstChild) preview.removeChild(preview.firstChild);






            
            // Use CSS custom properties for dynamic colors
            preview.style.setProperty('--embed-color', color);

            if (embedTitle) {
                embedTitle.style.setProperty('--title-color', color);
            }
        }

        function sendEmbed() {


            
            if (!title && !description) {
                alert('Por favor, preenche pelo menos o título ou a descrição');
                return;
            }
            
            alert('Embed enviado com sucesso! (Funcionalidade simulada)');
        }

        // Logs functions
        function refreshLogs() {


            

            newLog.className = 'log-entry info';




            container.insertBefore(newLog, container.firstChild);
            
            // Limitar a 50 logs
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function clearLogs() {
            if (confirm('Tens a certeza de que queres limpar todos os logs?')) {


                while (container.firstChild) container.removeChild(container.firstChild);

                newLog.className = 'log-entry info';





            }
        }

        // Initialize dashboard when page loads

            new YSNMDashboard();

            // Auto-update embed preview when typing

            embedInputs.forEach(id => {

                if (element) {
                    element.addEventListener('input', updateEmbedPreview);
                }
            });

            // Run lightweight DOM sanitation and attach image fallbacks early
            try {
                sanitizeTemplatePlaceholders();
                attachImageFallbacks();
            } catch (e) {
                // Don't break dashboard init if sanitation fails

            }
        });
    </script>

    <script>
        // UI and runtime fixes (sanitization + debug wrapper)
        (function(){
            // Simple debug flag persisted in localStorage (user toggle available)
            function isDebug() { return localStorage.getItem('YSNM_DEBUG') === '1'; }
            function setDebug(v) { localStorage.setItem('YSNM_DEBUG', v ? '1' : '0'); }

            // Wrap console.* so it only logs when debug is enabled
            const _console = { log: console.log.bind(console), warn: console.warn.bind(console), error: console.error.bind(console), info: console.info.bind(console) };
            ['log','warn','error','info'].forEach(fn => {
                console[fn] = function(...args){ if (isDebug()) _console[fn](...args); };
            });

            // Replace any visible template placeholders like $ + '{' + '...}' in text nodes and attributes
            window.sanitizeTemplatePlaceholders = function(){
                const placeholderRegex = /\$\{[^}]+\}/g;

                // Fix attributes (src, href, data-*)
                document.querySelectorAll('[src],[href],[data-src]').forEach(el => {
                    ['src','href','data-src'].forEach(attr => {
                        if (!el.hasAttribute(attr)) return;
                        const val = el.getAttribute(attr);
                        if (!val) return;
                        // encoded forms sometimes appear (e.g. %24%7B)
                        if (val.includes('$' + '{') || val.includes('%24%7B')) {
                            // If it's an image, set a safe default
                            if (el.tagName.toLowerCase() === 'img') {
                                el.setAttribute('src','/default-avatar.png');
                                el.removeAttribute('srcset');
                            } else {
                                el.removeAttribute(attr);
                            }
                        }
                    });
                });

                // Clean text nodes containing placeholders
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
                const toChange = [];
                while(walker.nextNode()){
                    const node = walker.currentNode;
                    if (node.nodeValue && placeholderRegex.test(node.nodeValue)) {
                        toChange.push(node);
                    }
                }
                toChange.forEach(n => n.nodeValue = n.nodeValue.replace(placeholderRegex, ''));
            };

            // Attach robust fallback handler to images
            window.attachImageFallbacks = function(){
                const defaultSrc = '/default-avatar.png';
                document.querySelectorAll('img').forEach(img => {
                    // If src looks like an unprocessed template, fix it now
                    const src = img.getAttribute('src') || '';
                    if (src.includes('$' + '{') || src.includes('%24%7B')) {
                        img.src = defaultSrc;
                    }

                    // Avoid infinite loops
                    img.addEventListener('error', function onErr(){
                        try { img.removeEventListener('error', onErr); } catch(e){}
                        // Replace with inline SVG fallback for crispness
                        img.src = defaultSrc;
                        img.style.objectFit = 'cover';
                    });
                });
            };

            // Small floating control for toggling debug mode and running sanitizers
            function createDebuggerWidget(){
                if (document.getElementById('ysnm-debug-widget')) return;
                const w = document.createElement('div');
                w.id = 'ysnm-debug-widget';
                w.style.cssText = 'position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.6);color:#fff;padding:8px;border-radius:8px;font-size:12px;z-index:10001;backdrop-filter:blur(4px);';
                const inner = document.createElement('div'); inner.className = 'flex-row';
                const toggleBtn = document.createElement('button'); toggleBtn.id = 'ysnm-debug-toggle'; toggleBtn.title = 'Toggle debug'; toggleBtn.style.cssText = 'background:#111;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer;'; toggleBtn.textContent = isDebug() ? 'DEBUG ON' : 'debug';
                const fixBtn = document.createElement('button'); fixBtn.id = 'ysnm-sanitize-btn'; fixBtn.title = 'Fix placeholders'; fixBtn.style.cssText = 'background:#0b78d1;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer;'; fixBtn.textContent = 'Fix';
                inner.appendChild(toggleBtn); inner.appendChild(fixBtn);
                w.appendChild(inner);
                document.body.appendChild(w);
                toggleBtn.addEventListener('click', ()=>{
                    setDebug(!isDebug());
                    toggleBtn.textContent = isDebug() ? 'DEBUG ON' : 'debug';
                    // Confirm reload to avoid accidental refresh loops
                    if (confirm('Reload page to apply debug state?')) {
                        try { window.location.reload(); } catch(e) { /* noop */ }
                    }
                });
                fixBtn.addEventListener('click', ()=>{ sanitizeTemplatePlaceholders(); attachImageFallbacks(); alert('Sanitização aplicada'); });
            }

            // Run on load (non-blocking)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => { createDebuggerWidget(); });
            } else {
                createDebuggerWidget();
            }
        })();

    </script>

    <script>
        // Production authentication helper functions
        function promptForToken() {
            const token = prompt('Insira o token de acesso para Railway:');
            if (token && token.trim()) {
                if (!confirm('Guardar este token no armazenamento local? Isto é inseguro em ambientes partilhados.')) return;
                localStorage.setItem('productionToken', token.trim());
                // Do not set authToken automatically; require explicit user action or reload
                alert('Token armazenado como productionToken. Use a opção de sessão para ativar.');
            }
        }
        
        function redirectToOAuth() {
            // Redirect to Discord OAuth
            window.location.href = '/auth/discord';
        }
        
        // Add token input to production interface
        if (window.location.hostname.includes('railway.app')) {
            document.addEventListener('DOMContentLoaded', function() {
                // Add production token input to top nav
                const navbar = document.querySelector('.navbar');
                if (navbar) {
                    const tokenInput = document.createElement('div'); tokenInput.className = 'ml-auto mr-3';
                    const prodInput = document.createElement('input'); prodInput.type = 'password'; prodInput.id = 'prodToken'; prodInput.placeholder = 'Token de Acesso'; prodInput.className = 'form-control form-control-sm'; prodInput.style.cssText = 'width:200px;display:inline-block;';
                    const setBtn = document.createElement('button'); setBtn.className = 'btn btn-primary btn-sm ml-2'; setBtn.textContent = 'Definir'; setBtn.addEventListener('click', setProductionToken);
                    tokenInput.appendChild(prodInput); tokenInput.appendChild(setBtn); navbar.appendChild(tokenInput);
                }
            });
        }
        
        function setProductionToken() {
            const tokenInput = document.getElementById('prodToken');
            const token = tokenInput?.value?.trim();
            if (token) {
                if (!confirm('Guardar este token no armazenamento local? Isto é inseguro em ambientes partilhados.')) return;
                localStorage.setItem('productionToken', token);
                // Do not auto-set authToken; admin should enable session explicitly
                tokenInput.value = '';
                alert('Token guardado como productionToken. Por favor ative sessão manualmente se necessário.');
            }
        }
    </script>
    <script>
        // Sanity guard: remove any visible text nodes that look like raw JS leaking into the page
        (function(){
            try {
                const suspiciousRe = /\b(document\.|appendChild\(|function\s+\w+\s*\(|console\.|\bconst\s+\w+|\blet\s+\w+|\bvar\s+\w+|=>)\b/;
                function cleanse(root){
                    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
                    const toReplace = [];
                    while(walker.nextNode()){
                        const n = walker.currentNode;
                        if (!n.nodeValue) continue;
                        const txt = n.nodeValue.trim();
                        if (txt.length < 10) continue;
                        if (suspiciousRe.test(txt)) toReplace.push(n);
                    }
                    toReplace.forEach(n => {
                        try { console.warn('Sanity guard removed suspicious text node:', n.nodeValue.slice(0,120)); } catch(e){}
                        n.nodeValue = '';
                    });
                }
                // Run immediately and also after DOMContentLoaded to catch late inserts
                cleanse(document.body);
                document.addEventListener('DOMContentLoaded', () => { try { cleanse(document.body); } catch(e){} });
            } catch(e) { console.debug('Sanity guard failed', e); }
        })();
    </script>
    <script src="/js/toast-fallback.js"></script>
    <script src="/js/event-fallback.js"></script>
    <!-- Include DOMPurify then frontend helpers once at end of body -->
    <script src="/js/dompurify.min.js"></script>
    <script src="/js/frontend-helpers.js"></script>
    <script src="/js/script.js"></script>
</body>
</html>
