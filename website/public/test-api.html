<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 YSNM API Test Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- test-api styles moved to css/style.css (.test-api, .test-section, .status, etc) -->
</head>
<body>
    <!-- helpers loaded at end of body -->
    <div class="container">
        <h1>🧪 YSNM API Test Dashboard</h1>
    <p class="muted-center mb-1">
            Teste completo de todas as APIs do sistema YSNM
        </p>

        <div class="grid">
            <!-- Guilds API -->
            <div class="test-section">
                <h3>🏠 Guilds API</h3>
                <div class="api-info">GET /api/guilds</div>
                <button class="btn" onclick="testGuilds()">Testar Guilds</button>
                <span id="guilds-status" class="status loading">Aguardando...</span>
                <div id="guilds-result" class="result hidden"></div>
            </div>

            <!-- Channels API -->
            <div class="test-section">
                <h3>📺 Channels API</h3>
                <div class="api-info">GET /api/server/{serverId}/channels</div>
                <button class="btn" onclick="testChannels()">Testar Channels</button>
                <span id="channels-status" class="status loading">Aguardando...</span>
                <div id="channels-result" class="result hidden"></div>
            </div>

            <!-- Roles API -->
            <div class="test-section">
                <h3>👑 Roles API</h3>
                <div class="api-info">GET /api/server/{serverId}/roles</div>
                <button class="btn" onclick="testRoles()">Testar Roles</button>
                <span id="roles-status" class="status loading">Aguardando...</span>
                <div id="roles-result" class="result hidden"></div>
            </div>

            <!-- Members API -->
            <div class="test-section">
                <h3>👥 Members API</h3>
                <div class="api-info">GET /api/server/{serverId}/members</div>
                <button class="btn" onclick="testMembers()">Testar Members</button>
                <span id="members-status" class="status loading">Aguardando...</span>
                <div id="members-result" class="result hidden"></div>
            </div>

            <!-- Tickets API -->
            <div class="test-section">
                <h3>🎫 Tickets API</h3>
                <div class="api-info">GET /api/tickets</div>
                <button class="btn" onclick="testTickets()">Testar Tickets</button>
                <span id="tickets-status" class="status loading">Aguardando...</span>
                <div id="tickets-result" class="result hidden"></div>
            </div>

            <!-- Logs API -->
            <div class="test-section">
                <h3>📊 Logs API</h3>
                <div class="api-info">GET /api/logs</div>
                <button class="btn" onclick="testLogs()">Testar Logs</button>
                <span id="logs-status" class="status loading">Aguardando...</span>
                <div id="logs-result" class="result hidden"></div>
            </div>

            <!-- Moderation APIs -->
            <div class="test-section">
                <h3>🛡️ Moderation Tests</h3>
                <div class="api-info">POST /api/server/{serverId}/timeout (dry-run)</div>
                <button class="btn" onclick="testModeration()">Testar Moderação</button>
                <span id="moderation-status" class="status loading">Aguardando...</span>
                <div id="moderation-result" class="result hidden"></div>
            </div>

            <!-- System Status -->
            <div class="test-section">
                <h3>⚙️ System Status</h3>
                <div class="api-info">Informações do sistema</div>
                <button class="btn" onclick="testSystemStatus()">Verificar Sistema</button>
                <span id="system-status" class="status loading">Aguardando...</span>
                <div id="system-result" class="result hidden"></div>
            </div>
        </div>

    <div class="test-section mb-1">
            <h3>🔄 Teste Completo</h3>
            <button class="btn btn-lg" onclick="runAllTests()">
                ▶️ Executar Todos os Testes
            </button>
            <div id="overall-status" class="overall-status"></div>
        </div>
    </div>

    </script>
    
    </div>
    
    <script>
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(endpoint, options);
                const data = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function updateStatus(testName, success, message = '') {
            const statusEl = document.getElementById(testName + '-status');
            const resultEl = document.getElementById(testName + '-result');

            statusEl.className = 'status ' + (success ? 'success' : 'error');
            statusEl.textContent = success ? '✅ Sucesso' : '❌ Erro';

            if (message) {
                resultEl.classList.remove('hidden');
                resultEl.textContent = message;
            }
        }

        async function testGuilds() {
            console.log('🏠 Testando Guilds API...');
            const result = await makeApiCall('/api/guilds');
            
            if (result.success) {
                const guilds = result.data.guilds || [];
                // build safe message using text nodes
                const msg = '✅ ' + guilds.length + ' servidor(es) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('guilds', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('guilds', false, '❌ Erro: ' + err);
            }
        }

        async function testChannels() {
            console.log('📺 Testando Channels API...');
            const result = await makeApiCall('/api/server/' + encodeURIComponent(SERVER_ID) + '/channels');

            if (result.success) {
                const channels = result.data.channels || [];
                const msg = '✅ ' + channels.length + ' canal(is) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('channels', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('channels', false, '❌ Erro: ' + err);
            }
        }

        async function testRoles() {
            console.log('👑 Testando Roles API...');
            const result = await makeApiCall('/api/server/' + encodeURIComponent(SERVER_ID) + '/roles');

            if (result.success) {
                const roles = result.data.roles || [];
                const msg = '✅ ' + roles.length + ' cargo(s) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('roles', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('roles', false, '❌ Erro: ' + err);
            }
        }

        async function testMembers() {
            console.log('👥 Testando Members API...');
            const result = await makeApiCall('/api/server/' + encodeURIComponent(SERVER_ID) + '/members');

            if (result.success) {
                const members = result.data.members || [];
                const msg = '✅ ' + members.length + ' membro(s) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('members', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('members', false, '❌ Erro: ' + err);
            }
        }

        async function testTickets() {
            console.log('🎫 Testando Tickets API...');
            const result = await makeApiCall('/api/tickets');
            
            if (result.success) {
                const tickets = result.data.tickets || [];
                const msg = '✅ ' + tickets.length + ' ticket(s) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('tickets', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('tickets', false, '❌ Erro: ' + err);
            }
        }

        async function testLogs() {
            console.log('📊 Testando Logs API...');
            const result = await makeApiCall('/api/logs');
            
            if (result.success) {
                const logs = result.data.logs || [];
                const msg = '✅ ' + logs.length + ' log(s) encontrado(s)\n\n' + JSON.stringify(result.data, null, 2);
                updateStatus('logs', true, msg);
            } else {
                const err = typeof result.error === 'string' ? result.error : (result.data?.error || 'Falha na API');
                updateStatus('logs', false, '❌ Erro: ' + err);
            }
        }

        async function testModeration() {
            console.log('🛡️ Testando Moderation API...');
            // Teste dry-run (sem executar ação real)
            const sid = encodeURIComponent(SERVER_ID);
            const message = 'ℹ️ Teste de moderação (simulação)\n\nEndpoints disponíveis:\n- POST /api/server/' + sid + '/timeout\n- POST /api/server/' + sid + '/kick\n- POST /api/server/' + sid + '/ban\n- POST /api/server/' + sid + '/unban-all\n- POST /api/server/' + sid + '/lock\n\n⚠️ Testes reais de moderação requerem IDs de usuário válidos';
            updateStatus('moderation', true, message);
        }

        async function testSystemStatus() {
            console.log('⚙️ Verificando System Status...');
            
            const systemInfo = {
                timestamp: new Date().toISOString(),
                server: 'localhost:4000',
                environment: 'development',
                features: {
                    authentication: '✅ Bypass ativo (dev)',
                    database: '✅ SQLite conectado',
                    discordBot: '✅ Bot online',
                    apiEndpoints: '✅ Funcionais'
                }
            };
            
            const message = '✅ Sistema funcionando corretamente\n\n' + JSON.stringify(systemInfo, null, 2);
            updateStatus('system', true, message);
        }

        async function runAllTests() {
            const overallStatus = document.getElementById('overall-status');
            overallStatus.textContent = '🔄 Executando todos os testes...';
            
            const tests = [
                { name: 'Guilds', fn: testGuilds },
                { name: 'Channels', fn: testChannels },
                { name: 'Roles', fn: testRoles },
                { name: 'Members', fn: testMembers },
                { name: 'Tickets', fn: testTickets },
                { name: 'Logs', fn: testLogs },
                { name: 'Moderation', fn: testModeration },
                { name: 'System', fn: testSystemStatus }
            ];
            
            let passed = 0;
            
            for (const test of tests) {
                try {
                    await test.fn();
                    passed++;
                    await new Promise(resolve => setTimeout(resolve, 500)); // Delay entre testes
                } catch (error) {
                    console.error('❌ Teste ' + test.name + ' falhou:', error);
                }
            }
            
            const total = tests.length;
            const success = passed === total;
            
            // Build a safe DOM summary instead of assigning innerHTML
            while (overallStatus.firstChild) overallStatus.removeChild(overallStatus.firstChild);
            const wrap = document.createElement('div');
            wrap.style.color = success ? '#10B981' : '#F59E0B';

            const line1 = document.createElement('div');
            line1.textContent = (success ? '🎉' : '⚠️') + ' Testes completos: ' + passed + '/' + total + ' passaram';
            wrap.appendChild(line1);

            const line2 = document.createElement('div');
            line2.textContent = success ? '✅ Sistema YSNM 100% funcional!' : '⚠️ Alguns componentes precisam de atenção';
            wrap.appendChild(line2);

            overallStatus.appendChild(wrap);
        }

        // Auto-executar teste básico ao carregar
        window.addEventListener('load', () => {
            console.log('🧪 YSNM API Test Dashboard carregado');
            setTimeout(() => {
                testSystemStatus();
            }, 1000);
        });
    </script>
        <script src="/js/toast-fallback.js"></script>
    </body>
    </html>
            <!-- Include DOMPurify then frontend helpers once at end of body -->
            <script src="/js/dompurify.min.js"></script>
            <script src="/js/frontend-helpers.js"></script>
