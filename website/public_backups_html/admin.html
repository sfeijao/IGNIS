<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - YSNM Bot</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Admin page styles moved to css/style.css -->
</head>
<body>
    <!-- page content scripts will be loaded at end of body to ensure DOM is available -->
    <div class="container">
    <!-- frontend helpers intentionally loaded at end of body -->
        <div class="header">
            <h1>‚öôÔ∏è Administra√ß√£o</h1>
            <p>Painel de controle completo do servidor</p>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">üìä Vis√£o Geral</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Configura√ß√µes</button>
            <button class="tab-btn" onclick="switchTab('members')">üë• Membros</button>
            <button class="tab-btn" onclick="switchTab('channels')">üìù Canais</button>
            <button class="tab-btn" onclick="switchTab('roles')">üé≠ Cargos</button>
            <button class="tab-btn" onclick="switchTab('logs')">üìã Logs</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-success">üë•</div>
                    <div class="stat-value" id="totalMembers">-</div>
                    <div class="stat-label">Total de Membros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info">üü¢</div>
                    <div class="stat-value" id="onlineMembers">-</div>
                    <div class="stat-label">Membros Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-warning">üìù</div>
                    <div class="stat-value" id="totalChannels">-</div>
                    <div class="stat-label">Canais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-primary">üé≠</div>
                    <div class="stat-value" id="totalRoles">-</div>
                    <div class="stat-label">Cargos</div>
                </div>
            </div>

            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">üöÄ A√ß√µes R√°pidas</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="lockServer()">üîí Trancar Servidor</button>
                        <button class="btn btn-warning" onclick="unlockServer()">üîì Destrancar Servidor</button>
                        <button class="btn btn-danger" onclick="purgeInactiveMembers()">üßπ Limpar Inativos</button>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="card-title">üìä Status do Bot</div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Bot Online</div>
                            <div class="setting-description">Status atual do bot</div>
                        </div>
                        <div id="botStatus" class="text-success">üü¢ Online</div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Uptime</div>
                            <div class="setting-description">Tempo ativo</div>
                        </div>
                        <div id="botUptime">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">‚öôÔ∏è Configura√ß√µes Gerais</div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Sistema de Welcome</div>
                            <div class="setting-description">Mensagem autom√°tica para novos membros</div>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting('welcome')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Auto Modera√ß√£o</div>
                            <div class="setting-description">Modera√ß√£o autom√°tica de conte√∫do</div>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting('automod')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Logs de Auditoria</div>
                            <div class="setting-description">Registrar a√ß√µes dos membros</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('audit')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="card-title">üìù Canais de Sistema</div>
                    
                    <div class="form-group">
                        <label class="form-label">Canal de Welcome</label>
                        <select class="form-select" id="welcomeChannel">
                            <option value="">Selecionar canal...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Canal de Logs</label>
                        <select class="form-select" id="logChannel">
                            <option value="">Selecionar canal...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Canal de Modera√ß√£o</label>
                        <select class="form-select" id="modChannel">
                            <option value="">Selecionar canal...</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="saveChannelSettings()">üíæ Salvar Configura√ß√µes</button>
                </div>

                <div class="admin-card">
                    <div class="card-title">üõ°Ô∏è Configura√ß√µes de Modera√ß√£o</div>
                    
                    <div class="form-group">
                        <label class="form-label">Filtro de Palavr√µes</label>
                        <textarea class="form-textarea" id="bannedWords" placeholder="Digite palavras separadas por v√≠rgula..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Limite de Men√ß√µes</label>
                        <input type="number" class="form-input" id="mentionLimit" value="5">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto Timeout (minutos)</label>
                        <input type="number" class="form-input" id="autoTimeout" value="10">
                    </div>

                    <button class="btn btn-primary" onclick="saveModerationSettings()">üíæ Salvar Modera√ß√£o</button>
                </div>
            </div>
        </div>

        <!-- Members Tab -->
        <div id="members" class="tab-content">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">üë• Gerenciar Membros</div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="memberSearch" placeholder="Buscar membro..." onkeyup="searchMembers()">
                        <div class="search-icon">üîç</div>
                    </div>

                    <div class="member-list" id="memberList">
                        <div class="center-pad">
                            <div class="loading"></div>
                            <p class="mt-1">Carregando membros...</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="card-title">üé≠ A√ß√µes de Membro</div>
                    
                    <div class="form-group">
                        <label class="form-label">Membro Selecionado</label>
                        <input type="text" class="form-input" id="selectedMember" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">A√ß√£o</label>
                        <select class="form-select" id="memberAction">
                            <option value="timeout">Timeout</option>
                            <option value="kick">Expulsar</option>
                            <option value="ban">Banir</option>
                            <option value="unban">Desbanir</option>
                            <option value="role">Gerenciar Cargos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Motivo</label>
                        <textarea class="form-textarea" id="actionReason" placeholder="Motivo da a√ß√£o..."></textarea>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="executeMemberAction()">‚úÖ Executar</button>
                        <button class="btn btn-secondary" onclick="clearMemberAction()">üóëÔ∏è Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channels Tab -->
        <div id="channels" class="tab-content">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">üìù Criar Canal</div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome do Canal</label>
                        <input type="text" class="form-input" id="channelName" placeholder="nome-do-canal">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de Canal</label>
                        <select class="form-select" id="channelType">
                            <option value="GUILD_TEXT">Texto</option>
                            <option value="GUILD_VOICE">Voz</option>
                            <option value="GUILD_CATEGORY">Categoria</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoria Pai</label>
                        <select class="form-select" id="channelCategory">
                            <option value="">Nenhuma categoria</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea class="form-textarea" id="channelDescription" placeholder="Descri√ß√£o do canal..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="createChannel()">‚ûï Criar Canal</button>
                </div>

                <div class="admin-card">
                    <div class="card-title">üóÇÔ∏è Canais Existentes</div>
                    
                    <div id="channelsList">
                        <div class="center-pad">
                            <div class="loading"></div>
                            <p class="mt-1">Carregando canais...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Tab -->
        <div id="roles" class="tab-content">
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">üé≠ Criar Cargo</div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome do Cargo</label>
                        <input type="text" class="form-input" id="roleName" placeholder="Nome do cargo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cor do Cargo</label>
                        <input type="color" class="form-input" id="roleColor" value="#6B73FF">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Permiss√µes</label>
                        <div class="scroll-box">
                            <div class="setting-item mb-sm">
                                <span>Administrador</span>
                                <input type="checkbox" id="perm_administrator">
                            </div>
                            <div class="setting-item mb-sm">
                                <span>Gerenciar Servidor</span>
                                <input type="checkbox" id="perm_manage_guild">
                            </div>
                            <div class="setting-item mb-sm">
                                <span>Gerenciar Canais</span>
                                <input type="checkbox" id="perm_manage_channels">
                            </div>
                            <div class="setting-item mb-sm">
                                <span>Gerenciar Cargos</span>
                                <input type="checkbox" id="perm_manage_roles">
                            </div>
                            <div class="setting-item mb-sm">
                                <span>Expulsar Membros</span>
                                <input type="checkbox" id="perm_kick_members">
                            </div>
                            <div class="setting-item mb-sm">
                                <span>Banir Membros</span>
                                <input type="checkbox" id="perm_ban_members">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="createRole()">‚ûï Criar Cargo</button>
                </div>

                <div class="admin-card">
                    <div class="card-title">üìã Cargos Existentes</div>
                    
                    <div id="rolesList">
                        <div class="center-pad">
                            <div class="loading"></div>
                            <p class="mt-1">Carregando cargos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="admin-card">
                <div class="card-title">üìã Logs do Sistema</div>
                
                <div class="btn-group mb-1">
                    <button class="btn btn-secondary" onclick="filterLogs('all')">Todos</button>
                    <button class="btn btn-secondary" onclick="filterLogs('info')">Info</button>
                    <button class="btn btn-secondary" onclick="filterLogs('warning')">Avisos</button>
                    <button class="btn btn-secondary" onclick="filterLogs('error')">Erros</button>
                </div>
                <div id="logsList" class="logs-list">
                    <div class="center-pad">
                        <div class="loading"></div>
                        <p class="mt-1">Carregando logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar A√ß√£o</h3>
                <button class="close-btn" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <p id="confirmMessage">Tem certeza que deseja executar esta a√ß√£o?</p>
            <div class="btn-group">
                <button class="btn btn-danger" id="confirmBtn">Confirmar</button>
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';
        let selectedMember = null;

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
            loadChannels();
            loadRoles();
            loadMembers();
            loadLogs();
            try { sanitizeTemplatePlaceholders(); } catch(e) { console.debug('sanitize error', e); }
            try { attachImageFallbacks(); } catch(e) { console.debug('attachImageFallbacks error', e); }
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
        }

        async function loadOverviewData() {
            try {
                const response = await fetch('/api/admin/overview');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalMembers').textContent = data.stats.totalMembers;
                    document.getElementById('onlineMembers').textContent = data.stats.onlineMembers;
                    document.getElementById('totalChannels').textContent = data.stats.totalChannels;
                    document.getElementById('totalRoles').textContent = data.stats.totalRoles;
                    document.getElementById('botUptime').textContent = data.stats.uptime;
                }
            } catch (error) {
                showAlert('danger', 'Erro ao carregar dados gerais');
                console.debug('Erro ao carregar dados gerais:', error);
            }
        }

        async function loadMembers() {
            try {
                const response = await fetch('/api/admin/members');
                const data = await response.json();
                
                if (data.success) {
                    const memberList = document.getElementById('memberList');
                    if (memberList) { while (memberList.firstChild) memberList.removeChild(memberList.firstChild); }
                    if (!data.members || data.members.length === 0) {
                        const none = document.createElement('div');
                        none.style.textAlign = 'center';
                        none.style.color = 'var(--text-muted)';
                        none.textContent = 'Nenhum membro encontrado';
                        memberList.appendChild(none);
                        return;
                    }

                    data.members.forEach(member => {
                        const item = document.createElement('div');
                        item.className = 'member-item';
                        item.addEventListener('click', () => selectMember(String(member.id), String(member.username)));

                        const avatar = document.createElement('div');
                        avatar.className = 'member-avatar';
                        if (member.avatar) {
                            const img = document.createElement('img');
                            img.style.width = '100%'; img.style.height = '100%'; img.style.borderRadius = '50%';
                            img.src = sanitizeAttr(member.avatar) || '/default-avatar.png';
                            img.alt = member.username || '';
                            img.onerror = function() { this.onerror = null; this.src = '/default-avatar.png'; };
                            avatar.appendChild(img);
                        } else {
                            avatar.textContent = (member.username || '').charAt(0).toUpperCase();
                        }

                        const info = document.createElement('div');
                        info.className = 'member-info';
                        const name = document.createElement('div'); name.className = 'member-name'; name.textContent = safeText(member.username || '');
                        const role = document.createElement('div'); role.className = 'member-role'; role.textContent = (member.roles || []).join(', ') || 'Sem cargos';
                        info.appendChild(name); info.appendChild(role);

                        const statusDiv = document.createElement('div');
                        statusDiv.style.color = (member.status === 'online') ? 'var(--success)' : 'var(--text-muted)';
                        statusDiv.textContent = (member.status === 'online') ? 'üü¢' : '‚ö´';

                        item.appendChild(avatar);
                        item.appendChild(info);
                        item.appendChild(statusDiv);
                        memberList.appendChild(item);
                    });
                }
            } catch (error) {
                showAlert('danger', 'Erro ao carregar membros');
                console.debug('Erro ao carregar membros:', error);
            }
        }

        async function loadChannels() {
            try {
                const response = await fetch('/api/admin/channels');
                const data = await response.json();
                
                if (data.success) {
                    // Update channel selects
                    const selects = ['welcomeChannel', 'logChannel', 'modChannel', 'channelCategory'];
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) { while (select.firstChild) select.removeChild(select.firstChild); }
                        const defaultOpt = document.createElement('option'); defaultOpt.value = ''; defaultOpt.textContent = 'Selecionar canal...';
                        select.appendChild(defaultOpt);

                        data.channels.forEach(channel => {
                            if (selectId === 'channelCategory' && channel.type !== 'GUILD_CATEGORY') return;
                            if (selectId !== 'channelCategory' && channel.type === 'GUILD_CATEGORY') return;
                            const opt = document.createElement('option'); opt.value = String(channel.id); opt.textContent = safeText(channel.name);
                            select.appendChild(opt);
                        });
                    });
                    
                    // Update channels list
                    const channelsList = document.getElementById('channelsList');
                    if (channelsList) { while (channelsList.firstChild) channelsList.removeChild(channelsList.firstChild); }
                    data.channels.forEach(channel => {
                        const item = document.createElement('div'); item.className = 'member-item';
                        const icon = document.createElement('div'); icon.style.fontSize = '1.2rem';
                        icon.textContent = (channel.type === 'GUILD_TEXT') ? 'üìù' : (channel.type === 'GUILD_VOICE' ? 'üé§' : 'üìÅ');
                        const info = document.createElement('div'); info.className = 'member-info';
                        const name = document.createElement('div'); name.className = 'member-name'; name.textContent = safeText(channel.name);
                        const role = document.createElement('div'); role.className = 'member-role'; role.textContent = channel.type;
                        info.appendChild(name); info.appendChild(role);
                        const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.textContent = 'üóëÔ∏è'; btn.addEventListener('click', () => deleteChannel(String(channel.id)));
                        item.appendChild(icon); item.appendChild(info); item.appendChild(btn);
                        channelsList.appendChild(item);
                    });
                }
            } catch (error) {
                showAlert('danger', 'Erro ao carregar canais');
                console.debug('Erro ao carregar canais:', error);
            }
        }

        async function loadRoles() {
            try {
                const response = await fetch('/api/admin/roles');
                const data = await response.json();
                
                if (data.success) {
                    const rolesList = document.getElementById('rolesList');
                    if (rolesList) { while (rolesList.firstChild) rolesList.removeChild(rolesList.firstChild); }
                    data.roles.forEach(role => {
                        const item = document.createElement('div'); item.className = 'member-item';
                        const colorDiv = document.createElement('div'); colorDiv.style.width = '20px'; colorDiv.style.height = '20px'; colorDiv.style.borderRadius = '50%'; colorDiv.style.background = safeText(role.color || '#ccc');
                        const info = document.createElement('div'); info.className = 'member-info';
                        const name = document.createElement('div'); name.className = 'member-name'; name.textContent = safeText(role.name);
                        const membersDiv = document.createElement('div'); membersDiv.className = 'member-role'; membersDiv.textContent = String(role.members) + ' membros';
                        info.appendChild(name); info.appendChild(membersDiv);
                        const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.textContent = 'üóëÔ∏è'; btn.addEventListener('click', () => deleteRole(String(role.id)));
                        item.appendChild(colorDiv); item.appendChild(info); item.appendChild(btn);
                        rolesList.appendChild(item);
                    });
                }
            } catch (error) {
                showAlert('danger', 'Erro ao carregar cargos');
                console.debug('Erro ao carregar cargos:', error);
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch('/api/admin/logs');
                const data = await response.json();
                
                if (data.success) {
                    const logsList = document.getElementById('logsList');
                    if (logsList) { while (logsList.firstChild) logsList.removeChild(logsList.firstChild); }
                    data.logs.forEach(log => {
                        const item = document.createElement('div'); item.className = 'log-item ' + sanitizeAttr(log.level);
                        const header = document.createElement('div'); header.className = 'log-header';
                        const typeDiv = document.createElement('div'); typeDiv.className = 'log-type'; typeDiv.textContent = safeText(log.type);
                        const timeDiv = document.createElement('div'); timeDiv.className = 'log-time'; timeDiv.textContent = formatDate(log.timestamp);
                        header.appendChild(typeDiv); header.appendChild(timeDiv);
                        const messageDiv = document.createElement('div'); messageDiv.className = 'log-message'; messageDiv.textContent = safeText(log.message);
                        item.appendChild(header); item.appendChild(messageDiv);
                        logsList.appendChild(item);
                    });
                }
            } catch (error) {
                showAlert('danger', 'Erro ao carregar logs');
                console.debug('Erro ao carregar logs:', error);
            }
        }

        // ------------------ frontend hygiene helpers ------------------
        function sanitizeTemplatePlaceholders(root = document.body) {
            const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null, false);
            const placeholderPattern = /\$\{[^}]*\}/g;
            let node = walker.currentNode;
            while (node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    if (placeholderPattern.test(node.textContent)) {
                        node.textContent = node.textContent.replace(placeholderPattern, '');
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    ['src', 'href', 'data-src', 'alt', 'title', 'style'].forEach(attr => {
                        if (node.hasAttribute && node.hasAttribute(attr)) {
                            let val = node.getAttribute(attr) || '';
                            if (placeholderPattern.test(val) || val.includes('%24%7B')) {
                                val = val.replace(placeholderPattern, '');
                                val = val.replace(/%24%7B/g, '');
                                try { node.setAttribute(attr, val || ''); } catch(e) { }
                            }
                        }
                    });
                }
                node = walker.nextNode();
            }
        }

        function attachImageFallbacks(root = document.body) {
            const imgs = root.querySelectorAll ? root.querySelectorAll('img') : [];
            imgs.forEach(img => {
                try {
                    const src = img.getAttribute('src') || '';
                    if (!src || src.includes('$' + '{') || src.includes('%24%7B')) {
                        img.src = '/default-avatar.png';
                    }
                } catch(e) { }
                if (!img.onerror) {
                    img.onerror = function() { this.onerror = null; this.src = '/default-avatar.png'; };
                }
            });
        }

        function safeText(v) { if (v === null || v === undefined) return ''; return String(v).replace(/\$\{[^}]*\}/g, ''); }
        function sanitizeAttr(v) { if (!v) return ''; return String(v).replace(/\$\{[^}]*\}/g, '').replace(/%24%7B/g, ''); }

        function selectMember(memberId, username) {
            selectedMember = { id: memberId, username: username };
            document.getElementById('selectedMember').value = username;
        }

        function searchMembers() {
            const search = document.getElementById('memberSearch').value.toLowerCase();
            const members = document.querySelectorAll('.member-item');
            
            members.forEach(member => {
                const name = member.querySelector('.member-name').textContent.toLowerCase();
                if (name.includes(search)) member.classList.remove('hidden'); else member.classList.add('hidden');
            });
        }

        async function executeMemberAction() {
            if (!selectedMember) {
                showAlert('danger', 'Selecione um membro primeiro');
                return;
            }
            
            const action = document.getElementById('memberAction').value;
            const reason = document.getElementById('actionReason').value;
            
            showConfirmModal(
                'Executar ' + action + ' em ' + selectedMember.username + '?',
                () => performMemberAction(action, selectedMember.id, reason)
            );
        }

        async function performMemberAction(action, memberId, reason) {
            try {
                const response = await fetch('/api/admin/members/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, memberId, reason })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'A√ß√£o ' + action + ' executada com sucesso');
                    clearMemberAction();
                    loadMembers();
                } else {
                    showAlert('danger', data.message || 'Erro ao executar a√ß√£o');
                }
            } catch (error) {
                showAlert('danger', 'Erro ao executar a√ß√£o');
            }
        }

        function clearMemberAction() {
            selectedMember = null;
            document.getElementById('selectedMember').value = '';
            document.getElementById('actionReason').value = '';
        }

        async function createChannel() {
            const name = document.getElementById('channelName').value;
            const type = document.getElementById('channelType').value;
            const category = document.getElementById('channelCategory').value;
            const description = document.getElementById('channelDescription').value;
            
            if (!name) {
                showAlert('danger', 'Nome do canal √© obrigat√≥rio');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/channels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type, category, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'Canal criado com sucesso');
                    document.getElementById('channelName').value = '';
                    document.getElementById('channelDescription').value = '';
                    loadChannels();
                } else {
                    showAlert('danger', data.message || 'Erro ao criar canal');
                }
            } catch (error) {
                showAlert('danger', 'Erro ao criar canal');
            }
        }

        async function createRole() {
            const name = document.getElementById('roleName').value;
            const color = document.getElementById('roleColor').value;
            
            if (!name) {
                showAlert('danger', 'Nome do cargo √© obrigat√≥rio');
                return;
            }
            
            const permissions = [];
            document.querySelectorAll('[id^="perm_"]:checked').forEach(checkbox => {
                permissions.push(checkbox.id.replace('perm_', ''));
            });
            
            try {
                const response = await fetch('/api/admin/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color, permissions })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'Cargo criado com sucesso');
                    document.getElementById('roleName').value = '';
                    loadRoles();
                } else {
                    showAlert('danger', data.message || 'Erro ao criar cargo');
                }
            } catch (error) {
                showAlert('danger', 'Erro ao criar cargo');
            }
        }

        function toggleSetting(setting) {
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
            
            // Save setting to server
            saveSetting(setting, toggle.classList.contains('active'));
        }

        async function saveSetting(setting, value) {
            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [setting]: value })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    showAlert('danger', 'Erro ao salvar configura√ß√£o');
                }
            } catch (error) {
                showAlert('danger', 'Erro ao salvar configura√ß√£o');
            }
        }

        async function lockServer() {
            showConfirmModal(
                'Trancar o servidor ir√° impedir que membros sem permiss√µes especiais enviem mensagens. Continuar?',
                async () => {
                    try {
                        const response = await fetch('/api/admin/server/lock', { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.success) {
                            showAlert('success', 'Servidor trancado com sucesso');
                        } else {
                            showAlert('danger', data.message || 'Erro ao trancar servidor');
                        }
                    } catch (error) {
                        showAlert('danger', 'Erro ao trancar servidor');
                    }
                }
            );
        }

        async function unlockServer() {
            try {
                const response = await fetch('/api/admin/server/unlock', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'Servidor destrancado com sucesso');
                } else {
                    showAlert('danger', data.message || 'Erro ao destrancar servidor');
                }
            } catch (error) {
                showAlert('danger', 'Erro ao destrancar servidor');
            }
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(type, message) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = 'alert alert-' + type;
            alert.textContent = message;
            
            // Insert at top of container
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => alert.remove(), 5000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }
    </script>
    <script src="/js/toast-fallback.js"></script>
    <script src="/js/event-fallback.js"></script>
    <!-- Include DOMPurify then frontend helpers once at end of body -->
    <script src="/js/dompurify.min.js"></script>
    <script src="/js/frontend-helpers.js"></script>
</body>
</html>
